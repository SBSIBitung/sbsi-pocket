<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwRHyI4h7Kckbv-T18-AW8FmqG2YcLAbkBIOPekzh90GHcx_ZmzM17DRoB7S0DbXBGn/exec"; 
    let currentUser = null;
    let masterUMP = []; // Data historis dari Sheet2

    // Fungsi mencari UMP di database masterUMP
    function cariUMP(tahun) {
        let found = masterUMP.find(u => u.tahun == tahun);
        return found ? found.nilai : masterUMP[masterUMP.length - 1].nilai;
    }

    async function eksekusiAudit() {
        const t1Val = document.getElementById('tglMulai').value;
        const t2Val = document.getElementById('tglSelesai').value;
        if(!t1Val || !t2Val) return alert("Pilih tanggal!");

        const t1 = new Date(t1Val);
        const t2 = new Date(t2Val);
        const formatIDR = (n) => "Rp " + Math.round(n).toLocaleString('id-ID');

        let rincianHTML = "";
        let totalTHR = 0;
        let thnMulai = t1.getFullYear();
        let thnSelesai = t2.getFullYear();
        let totalTahunKerja = thnSelesai - thnMulai;

        // Loop untuk menghitung Upah per Tahun & THR
        for (let y = thnMulai; y <= thnSelesai; y++) {
            let nilaiUMP = cariUMP(y);
            totalTHR += nilaiUMP; // Asumsi 1x UMP per tahun
            rincianHTML += `<tr><td>Upah & THR Thn ${y}</td><td>${formatIDR(nilaiUMP)}</td></tr>`;
        }

        let uangKompensasi = totalTahunKerja * cariUMP(thnSelesai);
        let grandTotal = totalTHR + uangKompensasi;

        // Tampilkan Hasil di Layar
        document.getElementById('hasilPrint').innerHTML = `
            <div class="border p-3 shadow-sm bg-white">
                <h6 class="text-center fw-bold text-decoration-underline mb-3">RINCIAN AUDIT HAK ANGGOTA</h6>
                <table class="table table-sm table-bordered small">
                    <tr class="table-light"><td><b>Nama / NIK</b></td><td>${currentUser.nama} / ${currentUser.nik}</td></tr>
                    <tr class="table-light"><td><b>Masa Kerja</b></td><td>${totalTahunKerja} Tahun</td></tr>
                    <tr><td colspan="2" class="fw-bold bg-light">A. RINCIAN UPAH & THR HISTORIS</td></tr>
                    ${rincianHTML}
                    <tr><td colspan="2" class="fw-bold bg-light">B. KOMPENSASI / PESANGON</td></tr>
                    <tr><td>Uang Kompensasi</td><td>${formatIDR(uangKompensasi)}</td></tr>
                    <tr class="table-danger fw-bold"><td>TOTAL KEKURANGAN HAK</td><td>${formatIDR(grandTotal)}</td></tr>
                </table>
                <div class="mt-4 text-end small">Bitung, ${new Date().toLocaleDateString('id-ID')}<br><br><br><b>( ${currentUser.nama} )</b></div>
            </div>
        `;

        // Kirim data ke Sheet1
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "audit", nama: currentUser.nama, nik: currentUser.nik,
                tglMulai: t1Val, tglSelesai: t2Val, masaKerja: totalTahunKerja,
                totalTHR: totalTHR, totalKompensasi: uangKompensasi, grandTotal: grandTotal
            })
        });

        setTimeout(() => window.print(), 800);
    }
</script>
