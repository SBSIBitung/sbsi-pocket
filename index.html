<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mySBSI - Advokasi Buruh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --sbsi-red: #b71c1c; }
    body { background: #f4f4f4; font-family: sans-serif; }
    .btn-sbsi { background: var(--sbsi-red); color: white; border: none; }
    .card-login { max-width: 400px; margin: 80px auto; border-radius: 15px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    #loader { display: none; }
    .nav-sbsi { background: var(--sbsi-red); color: white; }
  </style>
</head>
<body>

<div id="app">
  <div id="loginSection" class="container">
    <div class="card card-login p-4">
      <div class="text-center mb-4">
        <h2 class="fw-bold text-danger">mySBSI</h2>
        <p class="text-muted small">Kalkulator Hak Buruh PP 35/2021</p>
      </div>
      <input type="text" id="username" class="form-control mb-2" placeholder="NIK (Username)">
      <input type="password" id="password" class="form-control mb-3" placeholder="Kata Sandi">
      <button onclick="prosesLogin()" id="btnLogin" class="btn btn-sbsi w-100 mb-2">LOGIN</button>
      <button onclick="masukGuest()" class="btn btn-outline-dark w-100 fw-bold small">GUEST</button>
      <div id="loader" class="text-center mt-3"><div class="spinner-border text-danger spinner-border-sm"></div></div>
      <div id="msgError" class="text-danger text-center mt-2 small fw-bold"></div>
      <button onclick="resetUrl()" class="btn btn-link btn-sm mt-3 text-muted" style="text-decoration:none">Ganti URL Web App</button>
    </div>
  </div>

  <div id="mainSection" style="display:none;">
    <nav class="navbar nav-sbsi px-3 mb-4 shadow-sm">
      <span class="navbar-brand fw-bold">mySBSI Dashboard</span>
      <button class="btn btn-sm btn-light fw-bold" onclick="location.reload()">Logout</button>
    </nav>
    <div class="container">
      <div id="viewGuest" class="card p-5 text-center shadow-sm" style="display:none;">
        <h3 class="text-danger fw-bold">Profil mySBSI</h3>
        <p>Gunakan akun Anggota untuk menghitung hak PHK & Pesangon.</p>
      </div>
      <div id="viewUser" style="display:none;">
        <div class="card p-4 shadow-sm border-0 mb-4">
          <h5 class="fw-bold text-danger">Kalkulator PHK</h5>
          <hr>
          <div class="row g-3">
            <div class="col-md-6"><label class="small fw-bold">Tgl Mulai</label><input type="date" id="tglMulai" class="form-control"></div>
            <div class="col-md-6"><label class="small fw-bold">Tgl PHK</label><input type="date" id="tglSelesai" class="form-control"></div>
            <div class="col-12"><label class="small fw-bold">Upah Terakhir</label><input type="number" id="upah" class="form-control" placeholder="Rp"></div>
            <div class="col-12"><button onclick="hitung()" class="btn btn-danger w-100">HITUNG HAK</button></div>
          </div>
          <div id="hasil" class="mt-4 p-3 bg-light rounded shadow-sm" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let appUrl = localStorage.getItem('sbsi_url');
let currentUser = {};

function resetUrl() {
  let url = prompt("Masukkan URL Web App Google Script Anda:", appUrl || "");
  if(url) {
    localStorage.setItem('sbsi_url', url);
    appUrl = url;
    location.reload();
  }
}

// Jika belum ada URL, minta saat startup
if(!appUrl) resetUrl();

function callback(res) {
  window.lastResponse = res;
}

function prosesLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(!u || !p) return alert("Isi Username/Sandi");
  
  document.getElementById('loader').style.display = 'block';
  
  const script = document.createElement('script');
  script.src = `${appUrl}?action=login&u=${u}&p=${p}&callback=callback`;
  
  document.body.appendChild(script);

  setTimeout(() => {
    document.getElementById('loader').style.display = 'none';
    if(window.lastResponse && window.lastResponse.success) {
      showDashboard(window.lastResponse);
    } else {
      document.getElementById('msgError').innerText = window.lastResponse ? window.lastResponse.message : "Gagal terhubung ke Script";
    }
  }, 2000);
}

function masukGuest() { showDashboard({role:'Guest', nama:'Tamu'}); }

function showDashboard(user) {
  currentUser = user;
  document.getElementById('loginSection').style.display='none';
  document.getElementById('mainSection').style.display='block';
  
  if(user.role === 'Guest') {
    document.getElementById('viewGuest').style.display='block';
  } else {
    document.getElementById('viewUser').style.display='block';
  }
}

function hitung() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  const upah = parseFloat(document.getElementById('upah').value);
  
  const diff = Math.floor((d2 - d1) / (1000*60*60*24*30.44));
  const thn = Math.floor(diff/12);
  let faktor = thn < 1 ? 1 : (thn >= 8 ? 9 : thn + 1);
  let total = faktor * upah;

  document.getElementById('hasil').style.display = 'block';
  document.getElementById('hasil').innerHTML = `
    <h6 class="fw-bold">Estimasi Hak:</h6>
    <div class="d-flex justify-content-between"><span>Masa Kerja:</span><span>${thn} Tahun</span></div>
    <div class="d-flex justify-content-between h5 fw-bold text-danger mt-2"><span>Total Pesangon:</span><span>Rp ${total.toLocaleString()}</span></div>
  `;
}
</script>
</body>
</html>
