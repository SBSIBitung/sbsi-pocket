<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary: #b71c1c; --secondary: #263238; }
    body { background: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
    .card-custom { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .bg-sbsi { background-color: var(--primary) !important; color: white; }
    .login-box { max-width: 400px; margin: 80px auto; }
    #loader { display:none; }
  </style>
</head>
<body>

<div id="app" class="container py-4">
  <div id="loginSection" class="login-box">
    <div class="card card-custom p-4 text-center">
      <h2 class="text-danger fw-bold mb-1">mySBSI</h2>
      <p class="text-muted small mb-4">Aplikasi Advokasi Hak Buruh</p>
      
      <div class="mb-2">
        <input type="text" id="username" class="form-control" placeholder="NIK (Username)">
      </div>
      <div class="mb-3">
        <input type="password" id="password" class="form-control" placeholder="PIN">
      </div>
      
      <button onclick="doLogin()" id="btnLogin" class="btn bg-sbsi w-100 mb-2">Login</button>
      <button onclick="guestView()" class="btn btn-outline-dark w-100">Info SBSI (Guest)</button>
      
      <div id="loader" class="mt-3"><div class="spinner-border text-danger spinner-border-sm"></div></div>
      <div id="errMsg" class="text-danger mt-2 small fw-bold"></div>
    </div>
  </div>

  <div id="mainSection" style="display:none;">
    <nav class="navbar navbar-dark bg-sbsi px-3 rounded shadow-sm mb-4">
      <span class="navbar-brand fw-bold">mySBSI Dashboard</span>
      <div class="ms-auto d-flex align-items-center">
        <span class="text-white small me-3" id="userInfo"></span>
        <button class="btn btn-sm btn-light" onclick="location.reload()">Logout</button>
      </div>
    </nav>

    <div id="guestContent" class="card card-custom p-5 text-center" style="display:none;">
      <h3 class="text-danger">Selamat Datang di SBSI</h3>
      <p class="lead">Serikat Buruh Sejahtera Indonesia</p>
      <hr>
      <p>Anda masuk sebagai <strong>Guest</strong>. Anda dapat melihat profil organisasi namun tidak dapat melakukan perhitungan hak atau mengakses database anggota.</p>
      <div class="row text-start mt-4">
        <div class="col-md-6">
          <h5>Visi Kami</h5>
          <p class="small text-muted">Mewujudkan buruh yang sejahtera, mandiri, dan bermartabat melalui advokasi yang akurat.</p>
        </div>
        <div class="col-md-6">
          <h5>Hubungi Kami</h5>
          <p class="small text-muted">Untuk pendaftaran anggota dan akses kalkulator PHK, hubungi Admin cabang terdekat.</p>
        </div>
      </div>
    </div>

    <div id="authContent" style="display:none;">
      <div class="row">
        <div class="col-lg-5">
          <div class="card card-custom p-4 mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-calculator"></i> Kalkulator Hak PHK</h5>
            <div class="mb-2">
              <label class="small fw-bold">Tanggal Mulai Kerja</label>
              <input type="date" id="tglMulai" class="form-control">
            </div>
            <div class="mb-2">
              <label class="small fw-bold">Tanggal Selesai/PHK</label>
              <input type="date" id="tglSelesai" class="form-control">
            </div>
            <div class="mb-3">
              <label class="small fw-bold">Upah Terakhir (Pokok + Tun.Tetap)</label>
              <input type="number" id="upahUser" class="form-control" placeholder="Contoh: 4000000">
            </div>
            <button onclick="kalkulasi()" class="btn btn-danger w-100 fw-bold">MULAI HITUNG</button>
          </div>
        </div>

        <div class="col-lg-7">
          <div id="hasilArea" class="card card-custom p-4 border-start border-danger border-4" style="display:none;">
            <h5 class="text-danger fw-bold border-bottom pb-2">Hasil Perhitungan PP 35/2021</h5>
            <div id="rincian" class="mt-3"></div>
            <button id="btnSave" onclick="saveToSheet()" class="btn btn-success mt-3 w-100">SIMPAN HASIL</button>
          </div>

          <div id="adminArea" class="card card-custom p-4 mt-3" style="display:none;">
            <h5 class="fw-bold mb-3">Log Riwayat Perhitungan</h5>
            <div class="table-responsive">
              <table class="table table-hover table-sm small">
                <thead class="table-light"><tr><th>Nama</th><th>Total Hak</th><th>Aksi</th></tr></thead>
                <tbody id="tableRiwayat"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let uData = {};
let umpData = {};
let hasilGlobal = {};

function doLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(!u || !p) return alert("Masukkan NIK dan PIN!");
  
  document.getElementById('loader').style.display = 'block';
  document.getElementById('btnLogin').disabled = true;

  google.script.run.withSuccessHandler(res => {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('btnLogin').disabled = false;
    if(res.success) startApp(res);
    else document.getElementById('errMsg').innerText = res.message;
  }).loginUser(u, p);
}

function guestView() {
  startApp({role:'Guest', nama:'Tamu'});
}

function startApp(user) {
  uData = user;
  document.getElementById('loginSection').style.display='none';
  document.getElementById('mainSection').style.display='block';
  document.getElementById('userInfo').innerText = `${user.nama} [${user.role}]`;
  
  if(user.role === 'Guest') {
    document.getElementById('guestContent').style.display='block';
    document.getElementById('authContent').remove(); // Hapus fitur hitung dr DOM utk keamanan
  } else {
    document.getElementById('authContent').style.display='block';
    google.script.run.withSuccessHandler(d => umpData = d).getUMP();
    if(user.role === 'Admin' || user.role === 'Super Admin') loadAdmin();
  }
}

function kalkulasi() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  const upah = parseFloat(document.getElementById('upahUser').value);
  
  if(isNaN(d1) || isNaN(d2) || isNaN(upah)) return alert("Lengkapi data tanggal dan upah!");

  const selisihHari = (d2 - d1) / (1000*60*60*24);
  const masaKerjaBulan = Math.floor(selisihHari / 30.44);
  const masaKerjaTahun = Math.floor(masaKerjaBulan / 12);
  
  const thnAkhir = d2.getFullYear();
  const umpSkrg = umpData[thnAkhir] || 0;
  
  // Perhitungan Pesangon Pasal 40 (Sederhana)
  let faktor = masaKerjaTahun < 1 ? 1 : (masaKerjaTahun >= 8 ? 9 : masaKerjaTahun + 1);
  let totalPesangon = faktor * upah;
  let selisihGaji = upah < umpSkrg ? (umpSkrg - upah) * 12 : 0;

  hasilGlobal = {
    nama: uData.nama, tglMulai: d1.toISOString().split('T')[0], tglSelesai: d2.toISOString().split('T')[0],
    selisihGaji: selisihGaji, selisihTHR: 0, selisihKomp: 0, pesangon: totalPesangon,
    total: selisihGaji + totalPesangon,
    detail: { masaKerjaBulan, umpAcuan: umpSkrg }
  };

  document.getElementById('hasilArea').style.display='block';
  document.getElementById('rincian').innerHTML = `
    <div class="alert alert-secondary py-2 small">Masa Kerja: <b>${masaKerjaTahun} Thn ${masaKerjaBulan % 12} Bln</b></div>
    <div class="d-flex justify-content-between mb-1"><span>Selisih UMP:</span><span>Rp ${selisihGaji.toLocaleString()}</span></div>
    <div class="d-flex justify-content-between mb-3"><span>Uang Pesangon:</span><span>Rp ${totalPesangon.toLocaleString()}</span></div>
    <div class="d-flex justify-content-between border-top pt-2 h5 fw-bold text-danger">
      <span>Total Tuntutan:</span><span>Rp ${hasilGlobal.total.toLocaleString()}</span>
    </div>
  `;
}

function saveToSheet() {
  document.getElementById('btnSave').disabled = true;
  google.script.run.withSuccessHandler(m => {
    alert(m);
    document.getElementById('btnSave').disabled = false;
  }).saveToDatabase(hasilGlobal);
}

function loadAdmin() {
  document.getElementById('adminArea').style.display='block';
  google.script.run.withSuccessHandler(data => {
    let html = '';
    data.forEach(r => {
      html += `<tr><td>${r[1]}</td><td>Rp ${r[8].toLocaleString()}</td><td><button class="btn btn-sm btn-outline-primary" onclick="alert('Detail: ${r[9]}')">Detail</button></td></tr>`;
    });
    document.getElementById('tableRiwayat').innerHTML = html;
  }).getRiwayat();
}
</script>
</body>
</html>
