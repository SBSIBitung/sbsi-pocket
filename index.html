<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI Pocket Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Palette Warna Biru Keren */
        :root { 
            --primary-blue: #0f4c81; /* Classic Blue */
            --light-blue: #e3f2fd;
            --accent-blue: #00d2ff;
            --dark-blue: #0a2647;
            --soft-gray: #f8f9fa;
        }

        body { background-color: var(--soft-gray); font-family: 'Segoe UI', Roboto, sans-serif; color: #333; margin: 0; }

        /* Splash Screen */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.8s ease; }
        .splash-logo { width: 140px; filter: drop-shadow(0 5px 15px rgba(15, 76, 129, 0.2)); }
        
        /* Layout APK */
        .top-nav { background: var(--dark-blue); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--accent-blue); }
        .card-pro { border: none; border-radius: 24px; background: white; box-shadow: 0 10px 30px rgba(10, 38, 71, 0.08); transition: 0.3s; }
        
        /* Buttons */
        .btn-blue { background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue)); color: white; border: none; border-radius: 15px; padding: 14px; font-weight: 700; width: 100%; box-shadow: 0 5px 15px rgba(15, 76, 129, 0.3); }
        .btn-blue:active { transform: scale(0.98); }

        /* Custom Input */
        .form-control { border-radius: 12px; border: 1.5px solid #eee; padding: 12px; background: #fcfdfe; }
        .form-control:focus { border-color: var(--accent-blue); box-shadow: none; background: white; }

        /* Area Cetak / Print Area */
        #printArea { display: none; }
        @media print {
            .no-print { display: none !important; }
            #printArea { display: block !important; padding: 30px; font-family: serif; }
            .kop { border-bottom: 4px solid var(--primary-blue); display: flex; align-items: center; padding-bottom: 15px; }
            .badge-print { background: var(--primary-blue) !important; color: white !important; padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px; -webkit-print-color-adjust: exact; }
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading { position: fixed; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner-grow text-primary"></div><div class="mt-3 fw-bold text-primary">Sinkronisasi Server...</div></div>

<div id="splash">
    <img src="Logo_SBSI.png" class="splash-logo">
    <div class="mt-4 fw-bold" style="letter-spacing: 6px; color: var(--primary-blue); font-size: 1.2rem;">mySBSI</div>
</div>

<div id="printArea">
    <div class="kop">
        <img src="Logo_SBSI.png" width="80" class="me-4">
        <div>
            <h2 class="m-0 fw-bold" style="color: var(--primary-blue);">FSBSI DPC KOTA BITUNG</h2>
            <p class="m-0 fw-bold">FEDERASI SERIKAT BURUH SEJAHTERA INDONESIA</p>
            <p class="m-0 small">Laporan Audit Hak Ketenagakerjaan Digital</p>
        </div>
    </div>
    <div class="mt-4">
        <h4 class="text-center fw-bold mb-4">RINCIAN TUNTUTAN HAK</h4>
        <table class="table table-bordered">
            <thead class="table-light"><tr><th>Keterangan Hak</th><th class="text-end">Jumlah</th></tr></thead>
            <tbody>
                <tr><td>Selisih Upah UMP (Prorata)</td><td id="prUMP" class="text-end fw-bold"></td></tr>
                <tr><td>Selisih Kekurangan THR</td><td id="prTHR" class="text-end fw-bold"></td></tr>
                <tr><td>Uang Kompensasi</td><td id="prKomp" class="text-end fw-bold"></td></tr>
                <tr><td>Pesangon & UPMK (<span id="prDetail"></span>)</td><td id="prPesangon" class="text-end fw-bold"></td></tr>
            </tbody>
        </table>
        <div class="badge-print">
            <h3 class="m-0 fw-bold">TOTAL TUNTUTAN: <span id="prTotal"></span></h3>
        </div>
        <div class="mt-5 d-flex justify-content-between text-center">
            <div style="width:200px">Audit Oleh,<br><br><br><b>( ________________ )</b></div>
            <div style="width:200px">Anggota,<br><br><br><b id="prNama">--</b></div>
        </div>
    </div>
</div>

<div class="no-print">
    <div id="secLogin" class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 100vh; background: linear-gradient(to bottom, #ffffff, var(--light-blue));">
        <img src="Logo My SBSI.png" width="160" class="mb-5">
        <div class="card card-pro p-4 w-100" style="max-width: 380px;">
            <h5 class="text-center fw-bold mb-4" style="color: var(--dark-blue);">Selamat Datang</h5>
            <div class="mb-3"><input type="text" id="lNik" class="form-control" placeholder="Nomor NIK"></div>
            <div class="mb-4"><input type="password" id="lPin" class="form-control" placeholder="PIN Keamanan"></div>
            <button class="btn-blue" onclick="doLogin()">MASUK APLIKASI</button>
        </div>
    </div>

    <div id="app" class="d-none">
        <nav class="top-nav">
            <span class="fw-bold"><i class="bi bi-grid-fill me-2"></i>mySBSI</span>
            <button class="btn btn-sm btn-outline-light rounded-pill px-3 fw-bold" onclick="location.reload()">KELUAR</button>
        </nav>

        <div class="container py-4">
            <div id="mainMenu" class="tab-content active text-center">
                <div class="card card-pro p-4 mb-4" style="background: var(--dark-blue); color: white;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-start">
                            <small class="opacity-75">Nama Anggota</small>
                            <h4 id="uNama" class="fw-bold m-0">--</h4>
                        </div>
                        <i class="bi bi-patch-check-fill h1 text-info m-0"></i>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-12" onclick="showTab('tAudit')">
                        <div class="card card-pro p-4 d-flex flex-row align-items-center shadow-sm">
                            <div class="rounded-circle bg-primary text-white p-3 me-3"><i class="bi bi-calculator h3 m-0"></i></div>
                            <div class="text-start"><h6 class="fw-bold mb-0">Audit Hak PHK</h6><small class="text-muted">Hitung selisih UMP & Pesangon</small></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tAudit" class="tab-content">
                <div class="card card-pro p-4">
                    <h5 class="fw-bold mb-4" style="color: var(--primary-blue);"><i class="bi bi-file-earmark-text me-2"></i>Form Audit Data</h5>
                    <div id="s1">
                        <div class="mb-3"><label class="small fw-bold text-muted">Tanggal Mulai Kerja</label><input type="date" id="d1" class="form-control"></div>
                        <div class="mb-4"><label class="small fw-bold text-muted">Tanggal Efektif PHK</label><input type="date" id="d2" class="form-control"></div>
                        <button class="btn-blue" onclick="genProrata()">LANJUTKAN</button>
                        <button class="btn btn-link w-100 mt-2 text-decoration-none text-muted" onclick="showTab('mainMenu')">Kembali</button>
                    </div>

                    <div id="s2" class="d-none">
                        <div id="listIn" class="mb-4 p-3 border rounded shadow-inner bg-white" style="max-height: 300px; overflow-y: auto;"></div>
                        <h6 class="fw-bold mb-3 border-bottom pb-2" style="color: var(--primary-blue);">Kompensasi Tambahan</h6>
                        <div class="row g-2 mb-4">
                            <div class="col-6"><label class="small fw-bold text-muted">Selisih THR</label><input type="number" id="inThr" class="form-control" value="0"></div>
                            <div class="col-6"><label class="small fw-bold text-muted">Uang Kompensasi</label><input type="number" id="inKomp" class="form-control" value="0"></div>
                            <div class="col-12 mt-3"><label class="small fw-bold text-muted">Pesangon & UPMK</label><input type="number" id="inPesangon" class="form-control" placeholder="Rp 0"></div>
                        </div>
                        <button class="btn-blue" onclick="prosesAudit()">HITUNG & LIHAT LAPORAN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbz-vCIKk65uvAgeDLC4jziNJnK5SgH7FPnSoe-IR1ghtFreUvHKHm8jwEOGxsQLUxbN/exec"; // Ganti URL ini
    let USER_NAME = "";

    window.onload = () => { setTimeout(() => { 
        document.getElementById('splash').style.opacity = '0'; 
        setTimeout(() => document.getElementById('splash').style.display = 'none', 800);
    }, 2000); };

    async function doLogin(){
        const nik = document.getElementById('lNik').value, pin = document.getElementById('lPin').value;
        loader(true);
        try {
            const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', nik, pin})});
            const d = await r.json();
            if(d.status==='success'){
                USER_NAME = d.user.nama;
                document.getElementById('secLogin').classList.add('d-none');
                document.getElementById('app').classList.remove('d-none');
                document.getElementById('uNama').innerText = d.user.nama;
            } else alert(d.message);
        } catch(e) { alert("Server tidak merespon."); }
        loader(false);
    }

    function genProrata(){
        const d1 = new Date(document.getElementById('d1').value), d2 = new Date(document.getElementById('d2').value);
        if(isNaN(d1) || isNaN(d2)) return alert("Isi tanggal!");
        let h = "";
        let curr = new Date(d1.getFullYear(), d1.getMonth(), 1);
        while(curr <= d2){
            let l = (curr.getMonth()+1)+"/"+curr.getFullYear();
            h += `<div class="mb-3"><label class="small text-muted fw-bold">Gaji ${l}</label><input type="number" class="form-control in-g" data-b="${l}" value="3500000"></div>`;
            curr.setMonth(curr.getMonth()+1);
        }
        document.getElementById('listIn').innerHTML = h;
        document.getElementById('s1').classList.add('d-none');
        document.getElementById('s2').classList.remove('d-none');
    }

    async function prosesAudit(){
        loader(true);
        const rincian = Array.from(document.querySelectorAll('.in-g')).map(i=>({ bulan: i.dataset.b, gaji: Number(i.value) }));
        const payload = { 
            action:'audit', 
            tglMulai:document.getElementById('d1').value, 
            tglSelesai:document.getElementById('d2').value, 
            rincianGaji:rincian,
            thrManual: Number(document.getElementById('inThr').value),
            kompManual: Number(document.getElementById('inKomp').value),
            pesangonTotal: Number(document.getElementById('inPesangon').value)
        };
        try {
            const r = await (await fetch(API, {method:'POST', body:JSON.stringify(payload)})).json();
            if(r.status==='success'){
                document.getElementById('prUMP').innerText = "Rp " + r.rincian.selisihUMP.toLocaleString('id-ID');
                document.getElementById('prTHR').innerText = "Rp " + r.rincian.thr.toLocaleString('id-ID');
                document.getElementById('prKomp').innerText = "Rp " + r.rincian.kompensasi.toLocaleString('id-ID');
                document.getElementById('prPesangon').innerText = "Rp " + r.rincian.pesangon.toLocaleString('id-ID');
                document.getElementById('prDetail').innerText = r.detailUP;
                document.getElementById('prTotal').innerText = "Rp " + r.rincian.total.toLocaleString('id-ID');
                document.getElementById('prNama').innerText = USER_NAME;
                window.print();
            }
        } catch(e){ alert("Perhitungan gagal."); }
        loader(false);
    }

    function showTab(id){
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function loader(s){ document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
