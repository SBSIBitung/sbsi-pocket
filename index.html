<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mySBSI Pocket Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --primary: #0d47a1; --dark: #002171; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .card-pro { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-blue { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; }
        .top-nav { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px; margin-bottom: 15px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary"></div></div>

<div id="viewLogin" class="view-section active">
    <div class="container py-5">
        <div class="text-center mb-4">
            <img src="https://raw.githubusercontent.com/sbsibitung/sbsi-pocket/main/Logo_SBSI.png" width="70">
            <h4 class="fw-bold mt-2">mySBSI Pocket</h4>
        </div>
        <div class="card-pro mx-auto" style="max-width: 350px;">
            <input type="text" id="lNik" class="form-control mb-3" placeholder="NIK">
            <input type="password" id="lPin" class="form-control mb-4" placeholder="PIN">
            <button class="btn-blue" onclick="handleLogin()">LOGIN</button>
        </div>
        
        <div class="card-pro mx-auto mt-4" style="max-width: 500px;">
            <h6 class="fw-bold text-primary"><i class="bi bi-info-circle-fill"></i> Tentang SBSI</h6>
            <p class="small text-muted">Serikat Buruh Sejahtera Indonesia (SBSI) adalah organisasi buruh independen pertama di Indonesia yang didirikan untuk memperjuangkan keadilan sosial, demokrasi, dan kesejahteraan buruh melalui Tiga Pilar Perjuangan.</p>
            <ul class="small text-muted">
                <li><b>Visi:</b> Terwujudnya buruh yang sejahtera dan bermartabat.</li>
                <li><b>Misi:</b> Melindungi, membela hak, dan meningkatkan kesejahteraan buruh beserta keluarganya.</li>
            </ul>
        </div>
    </div>
</div>

<div id="viewDashboard" class="view-section">
    <nav class="top-nav"><b>mySBSI Dashboard</b><button class="btn btn-sm btn-outline-light" onclick="location.reload()">Logout</button></nav>
    <div class="container py-4">
        <div class="card-pro bg-primary text-white d-flex align-items-center mb-3">
            <img id="userFoto" src="" style="width:55px; height:55px; border-radius:50%; border:2px solid #fff; margin-right:15px; object-fit:cover;">
            <div><h6 id="dashNama" class="fw-bold m-0"></h6><small id="dashRole"></small></div>
        </div>
        
        <div id="adminPanel" class="d-none mb-3">
            <button class="btn btn-warning w-100 fw-bold shadow-sm" onclick="openSearchModal()">üîç CARI ANGGOTA (ADMIN)</button>
        </div>

        <div class="row g-2 text-center">
            <div class="col-6" onclick="startAuditSelf()">
                <div class="card-pro h-100"><i class="bi bi-calculator fs-2 text-primary"></i><p class="small fw-bold mb-0 mt-1">Audit Hak</p></div>
            </div>
            <div class="col-6" onclick="changeView('viewEdukasi')">
                <div class="card-pro h-100"><i class="bi bi-play-circle-fill fs-2 text-success"></i><p class="small fw-bold mb-0 mt-1">Edukasi TV</p></div>
            </div>
        </div>
    </div>
</div>

<div id="viewEdukasi" class="view-section">
    <nav class="top-nav"><button class="btn text-white" onclick="changeView('viewDashboard')">‚Üê</button><b>Edukasi TV</b><div></div></nav>
    <div class="container py-4">
        <div class="card-pro">
            <h6 class="fw-bold mb-3"><i class="bi bi-music-note-beamed"></i> Mars SBSI</h6>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/S_8SNDV-9bY" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
        <div class="card-pro">
            <h6 class="fw-bold mb-3"><i class="bi bi-book"></i> Edukasi 1: Hak Buruh</h6>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/VIDEO_ID_HERE_1" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
        <div class="card-pro">
            <h6 class="fw-bold mb-3"><i class="bi bi-shield-check"></i> Edukasi 2: Tata Cara PHK</h6>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/VIDEO_ID_HERE_2" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

<div id="viewAudit" class="view-section">
    <nav class="top-nav"><button class="btn text-white" onclick="changeView('viewDashboard')">‚Üê</button><b id="auditTargetName">Audit Hak</b><div></div></nav>
    <div class="container py-4">
        <div class="card-pro">
            <div class="mb-2"><label class="small fw-bold">Tanggal Masuk</label><input type="date" id="d1" class="form-control"></div>
            <div class="mb-2"><label class="small fw-bold">Tanggal PHK</label><input type="date" id="d2" class="form-control" onchange="fetchUmp()"></div>
            <div class="mb-3"><label class="small fw-bold">UMP Acuan</label><input type="text" id="umpVal" class="form-control bg-light" readonly></div>
            <div class="mb-3"><label class="small fw-bold">Gaji Pokok + Tunj. Tetap</label><input type="number" id="gajiInp" class="form-control"></div>
            <button class="btn-blue" onclick="hitungFinal()">HITUNG HAK</button>
        </div>
        <div id="hasilBox" class="card-pro d-none bg-light border-primary">
            <h6 class="fw-bold text-center mb-3">HASIL AUDIT</h6>
            <table class="table table-sm small">
                <tr><td>Masa Kerja</td><td id="resMasa" class="text-end fw-bold"></td></tr>
                <tr><td>Pesangon</td><td id="resPesangon" class="text-end"></td></tr>
                <tr><td>Uang PMK</td><td id="resPmk" class="text-end"></td></tr>
                <tr class="table-primary fw-bold"><td>TOTAL</td><td id="resTotal" class="text-end"></td></tr>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSearch" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body">
    <input type="text" id="searchInp" class="form-control mb-3" placeholder="Cari Anggota..." onkeyup="filterAnggota()">
    <div id="listRes" class="list-group"></div>
</div></div></div></div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyI2q7Y-qEXflkl0_gnR4g-PqbGksQMsy0sQE8Kdn5ZQkiGZn6eZP08UATqxHSBwEVA/exec"; 
    let ALL_ANGGOTA = [], SESSION = {}, TARGET = {};

    function formatFoto(url) { return (url && url.includes('id=')) ? "https://lh3.googleusercontent.com/d/" + url.split('id=')[1] : "https://cdn-icons-png.flaticon.com/512/149/149071.png"; }

    async function handleLogin() {
        showLoading(true);
        const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', nik:document.getElementById('lNik').value, pin:document.getElementById('lPin').value})});
        const d = await r.json();
        if(d.status === 'success') {
            SESSION = d.user;
            document.getElementById('dashNama').innerText = SESSION.nama;
            document.getElementById('dashRole').innerText = SESSION.role;
            document.getElementById('userFoto').src = formatFoto(SESSION.foto);
            if(SESSION.role.toLowerCase()==='admin') { document.getElementById('adminPanel').classList.remove('d-none'); loadList(); }
            changeView('viewDashboard');
        } else alert(d.msg);
        showLoading(false);
    }

    async function fetchUmp() {
        const d2 = document.getElementById('d2').value;
        const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'getUmpRef', year:new Date(d2).getFullYear()})});
        const d = await r.json();
        if(d.status==='success' && d.ump > 0) {
            document.getElementById('umpVal').value = "Rp " + d.ump.toLocaleString();
        } else { document.getElementById('umpVal').removeAttribute('readonly'); document.getElementById('umpVal').value = ""; }
    }

    function hitungFinal() {
        const d1 = new Date(document.getElementById('d1').value);
        const d2 = new Date(document.getElementById('d2').value);
        const upah = parseFloat(document.getElementById('gajiInp').value);
        if(!d1 || !d2 || !upah) return alert("Lengkapi data!");

        const mk = (d2 - d1) / (1000 * 60 * 60 * 24 * 365.25);
        let p = (mk < 1)?1:(mk < 2)?2:(mk < 3)?3:(mk < 4)?4:(mk < 5)?5:(mk < 6)?6:(mk < 7)?7:(mk < 8)?8:9;
        let pmk = (mk < 3)?0:(mk < 6)?2:(mk < 9)?3:(mk < 12)?4:(mk < 15)?5:(mk < 18)?6:(mk < 21)?7:(mk < 24)?8:10;

        document.getElementById('hasilBox').classList.remove('d-none');
        document.getElementById('resMasa').innerText = mk.toFixed(1) + " Tahun";
        document.getElementById('resPesangon').innerText = "Rp " + (upah * p).toLocaleString();
        document.getElementById('resPmk').innerText = "Rp " + (upah * pmk).toLocaleString();
        document.getElementById('resTotal').innerText = "Rp " + ((upah * p) + (upah * pmk)).toLocaleString();
    }

    async function loadList() { const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'getAnggotaList'})}); const d = await r.json(); ALL_ANGGOTA = d.data; }
    function filterAnggota() {
        const key = document.getElementById('searchInp').value.toLowerCase();
        const res = ALL_ANGGOTA.filter(a => a.nama.toLowerCase().includes(key));
        document.getElementById('listRes').innerHTML = res.map(a => `<button class="list-group-item" onclick="selAudit('${a.nama}')">${a.nama}</button>`).join('');
    }
    function selAudit(n) { TARGET={nama:n}; document.getElementById('auditTargetName').innerText = "Audit: "+n; bootstrap.Modal.getInstance(document.getElementById('modalSearch')).hide(); changeView('viewAudit'); }
    function startAuditSelf() { TARGET={nama:SESSION.nama}; document.getElementById('auditTargetName').innerText = "Audit Mandiri"; changeView('viewAudit'); }
    function changeView(id) { document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
    function openSearchModal() { new bootstrap.Modal(document.getElementById('modalSearch')).show(); }
</script>
</body>
</html>
