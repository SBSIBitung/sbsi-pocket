<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBSI Pocket Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --sbsi-blue: #0d6efd; --bg-soft: #f4f7f6; }
        body { background: var(--bg-soft); font-family: 'Segoe UI', Tahoma, sans-serif; }
        .card-main { border: none; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.05); }
        .nav-link.active { color: var(--sbsi-blue) !important; border-bottom: 3px solid var(--sbsi-blue); }
        .currency-input { text-align: right; font-weight: bold; color: var(--sbsi-blue); }
        .xs-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #999; }
        /* Style agar PDF terlihat bersih */
        #pdf-area { background: white; padding: 40px !important; color: black !important; }
        .pdf-table td { padding: 8px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div id="secMain" class="container py-4">
    <div id="tab2" class="tab-content">
        <div class="card card-main p-4 bg-white mx-auto shadow-sm" style="max-width: 600px;">
            
            <div id="st1">
                <h5 class="fw-bold text-primary mb-4">Periode Kerja</h5>
                <div class="row g-3 mb-4">
                    <div class="col-6"><label class="xs-label">Tgl Mulai</label><input type="date" id="t1" class="form-control"></div>
                    <div class="col-6"><label class="xs-label">Tgl Selesai</label><input type="date" id="t2" class="form-control"></div>
                </div>
                <button class="btn btn-primary w-100 py-3 fw-bold" onclick="genGaji()">LANJUT</button>
            </div>

            <div id="st2" class="d-none">
                <div id="listG" class="border rounded mb-3 bg-white overflow-auto" style="max-height: 200px;"></div>
                <div id="listT" class="mb-4"></div>
                <button id="btnP" class="btn btn-primary w-100 py-3 shadow fw-bold" onclick="proses()">HITUNG HAK SEKARANG</button>
            </div>

            <div id="stRes" class="d-none mt-4">
                <div id="pdf-area" class="rounded-4 border">
                    <div class="text-center mb-4">
                        <img src="Logo_SBSI.png" width="80" class="mb-2">
                        <h4 class="fw-bold mb-0">LAPORAN AUDIT HAK PEKERJA</h4>
                        <p class="small text-muted">DPC FEDERASI SBSI KOTA BITUNG</p>
                    </div>

                    <div class="mb-4 small">
                        <div class="d-flex justify-content-between"><span>Nama Pekerja:</span> <b id="outNama"></b></div>
                        <div class="d-flex justify-content-between"><span>Periode Kerja:</span> <b id="outPeriode"></b></div>
                        <div class="d-flex justify-content-between"><span>Masa Kerja:</span> <b id="outMK"></b></div>
                    </div>

                    <div class="pdf-table small">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Selisih Upah (Prorata):</span> <b id="oG"></b>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Selisih THR:</span> <b id="oT"></b>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Selisih Kompensasi:</span> <b id="oK"></b>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom text-primary">
                            <span>Hak Pesangon (<span id="oD"></span>):</span> <b id="oP"></b>
                        </div>
                        <div class="d-flex justify-content-between py-4">
                            <h4 class="fw-bold text-danger">TOTAL TUNTUTAN:</h4>
                            <h4 class="fw-bold text-danger" id="oTot"></h4>
                        </div>
                    </div>

                    <div class="mt-5 row text-center small">
                        <div class="col-6"></div>
                        <div class="col-6">
                            <p class="mb-5">Bitung, <span id="tglSkrg"></span><br>Hormat Saya, Pekerja</p>
                            <br><br>
                            <b id="signNama"></b>
                        </div>
                    </div>
                </div>

                <div class="row g-2 mt-4">
                    <div class="col-6"><button class="btn btn-success w-100 py-3 fw-bold" onclick="downloadPDF()"><i class="bi bi-file-pdf"></i> SIMPAN PDF</button></div>
                    <div class="col-6"><button class="btn btn-outline-secondary w-100 py-3 fw-bold" onclick="location.reload()">ULANGI</button></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzkMkMO1EEfqyPPuASYYrpuCzo0WuBRnrNUdIUI1QOszCDvAZsGyr9weJZg6ru0ex5L/exec"; 
    let USER = null;

    // ... (Fungsi login & genGaji sama seperti sebelumnya) ...

    async function proses() {
        const b = document.getElementById('btnP');
        b.disabled = true; b.innerText = "SEDANG MENGHITUNG...";
        
        const data = {
            action: "audit",
            nama: USER.nama,
            tglMulai: document.getElementById('t1').value,
            tglSelesai: document.getElementById('t2').value,
            // (ambil data input lainnya seperti rincianGaji)
        };

        try {
            const res = await fetch(API, { method:'POST', body: JSON.stringify(data)});
            const r = await res.json();
            
            if(r.status === "success") {
                // UPDATE SEMUA ELEMENT DI LAYAR & PDF SECARA BERSAMAAN
                document.getElementById('outNama').innerText = USER.nama;
                document.getElementById('signNama').innerText = "(" + USER.nama + ")";
                document.getElementById('outPeriode').innerText = data.tglMulai + " s/d " + data.tglSelesai;
                document.getElementById('oG').innerText = "Rp " + r.gaji;
                document.getElementById('oT').innerText = "Rp " + r.thr;
                document.getElementById('oK').innerText = "Rp " + r.komp;
                document.getElementById('oP').innerText = "Rp " + r.pesangon;
                document.getElementById('oD').innerText = r.detail;
                document.getElementById('oTot').innerText = "Rp " + r.total;
                document.getElementById('tglSkrg').innerText = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});

                document.getElementById('st2').classList.add('d-none');
                document.getElementById('stRes').classList.remove('d-none');
            }
        } catch(e) { alert("Error: " + e.message); }
        b.disabled = false; b.innerText = "HITUNG SEKARANG";
    }

    function downloadPDF() {
        // Kunci keberhasilan: Ambil data LANGSUNG dari elemen yang terlihat di layar
        const element = document.getElementById('pdf-area');
        const namaFile = "SBSI_Bitung_Hasil_Perhitungan_Hak_" + USER.nama.replace(/\s+/g, '_');

        const opt = {
            margin: 10,
            filename: namaFile + '.pdf',
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
