<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mySBSI - Audit PP 35/2021</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --sbsi: #b71c1c; }
    body { background: #f4f4f4; font-size: 0.85rem; }
    .bg-sbsi { background: var(--sbsi); color: white; }
    .card-wizard { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; }
    .step { display: none; }
    .step.active { display: block; }
    .table-input input { border: 1px solid #ddd; border-radius: 4px; padding: 4px; width: 100%; text-align: right; }
  </style>
</head>
<body>

<div id="app">
  <div id="loginSection" class="container mt-5" style="max-width: 400px;">
    <div class="card card-wizard p-4 text-center">
      <h2 class="text-danger fw-bold">mySBSI</h2>
      <button onclick="showGuest()" class="btn bg-sbsi w-100 fw-bold">MASUK AUDIT (GUEST)</button>
    </div>
  </div>

  <div id="mainSection" style="display:none;">
    <nav class="navbar bg-sbsi px-3 mb-3 shadow-sm"><span class="fw-bold">Audit Tuntutan (PP 35/2021)</span></nav>
    <div class="container" style="max-width: 800px;">
      <div class="card card-wizard p-4">
        
        <div id="step1" class="step active">
          <h5 class="fw-bold text-danger mb-3">1. Periode Masa Kerja</h5>
          <div class="row g-3">
            <div class="col-6"><label class="small fw-bold">Mulai Kerja</label><input type="date" id="tglMulai" class="form-control"></div>
            <div class="col-6"><label class="small fw-bold">PHK</label><input type="date" id="tglSelesai" class="form-control"></div>
          </div>
          <button onclick="initAudit()" class="btn btn-danger w-100 mt-4 fw-bold">GENERATE TABEL AUDIT</button>
        </div>

        <div id="step2" class="step">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold text-danger">2. Audit Upah Bulanan</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="autoFill('in-gaji', '2.000.000')">Sampling 2jt</button>
          </div>
          <div class="table-responsive" style="max-height: 350px;">
            <table class="table table-sm border small">
              <thead class="bg-light sticky-top"><tr><th>Bulan</th><th>Diterima</th><th>UMP</th></tr></thead>
              <tbody id="bodyBulan"></tbody>
            </table>
          </div>
          <button onclick="nextStep(3)" class="btn btn-danger w-100 mt-3 fw-bold">KE THR & KOMP</button>
        </div>

        <div id="step3" class="step">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold text-danger">3. Audit THR & Kompensasi</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="autoFill('in-thr', '1.500.000')">Sampling 1,5jt</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm border small text-center">
              <thead class="bg-light"><tr><th>Tahun</th><th>Bulan</th><th>THR Diterima</th><th>Komp. Diterima</th></tr></thead>
              <tbody id="bodyTahun"></tbody>
            </table>
          </div>
          <button onclick="kalkulasiFinal()" class="btn btn-success w-100 mt-3 fw-bold">HITUNG HASIL AKHIR</button>
        </div>

        <div id="step4" class="step">
          <h4 class="text-danger fw-bold text-center mb-4">REKAPITULASI HAK</h4>
          <div id="rincianHasil" class="list-group list-group-flush mb-3"></div>
          <div class="bg-danger text-white p-3 rounded text-center shadow">
             <small class="fw-bold">TOTAL TUNTUTAN (SELISIH + PESANGON + UPMK)</small>
             <h2 id="grandTotal" class="fw-bold mt-1">Rp 0</h2>
          </div>
          <button onclick="location.reload()" class="btn btn-dark w-100 mt-4 fw-bold">ULANGI</button>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw0KNWfb8DyzdNR_GV1NpIipiO2jDYXakqQgkpU7Gvo6m3Lbb2abk_foi6BChjX_Qcn/exec"; 
let masterUMP = {};

function formatIDR(el) {
  let val = el.value.replace(/\D/g, "");
  el.value = new Intl.NumberFormat('id-ID').format(val);
}
function parseIDR(val) { return parseFloat(val.toString().replace(/\./g, "")) || 0; }
function callback(res) { window.lastRes = res; }

function autoFill(className, value) {
  document.querySelectorAll('.' + className).forEach(el => { el.value = value; });
}

function showGuest() {
  document.getElementById('loginSection').style.display='none';
  document.getElementById('mainSection').style.display='block';
  fetchUMP();
}

function fetchUMP() {
  const script = document.createElement('script');
  script.src = `${WEB_APP_URL}?action=getUMP&callback=callback`;
  document.body.appendChild(script);
  setTimeout(() => { masterUMP = window.lastRes || {}; }, 1500);
}

function nextStep(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step'+n).classList.add('active');
}

function initAudit() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  if(isNaN(d1) || isNaN(d2)) return alert("Isi tanggal!");

  let htmlBln = '';
  let curr = new Date(d1.getFullYear(), d1.getMonth(), 1);
  while(curr <= new Date(d2.getFullYear(), d2.getMonth(), 1)) {
    let thn = curr.getFullYear();
    htmlBln += `<tr><td>${curr.getMonth()+1}/${thn}</td>
      <td><input type="text" class="in-gaji" data-thn="${thn}" onkeyup="formatIDR(this)" value="0"></td>
      <td class="text-danger fw-bold">Rp ${(masterUMP[thn] || 0).toLocaleString()}</td></tr>`;
    curr.setMonth(curr.getMonth() + 1);
  }
  document.getElementById('bodyBulan').innerHTML = htmlBln;

  let htmlThn = '';
  for(let y = d1.getFullYear(); y <= d2.getFullYear(); y++) {
    let s = (y === d1.getFullYear()) ? d1.getMonth() : 0;
    let e = (y === d2.getFullYear()) ? d2.getMonth() : 11;
    let jml = (e - s) + 1;
    htmlThn += `<tr><td><b>${y}</b></td><td>${jml} bln</td>
      <td><input type="text" class="in-thr" data-thn="${y}" data-bln="${jml}" onkeyup="formatIDR(this)" value="0"></td>
      <td><input type="text" class="in-komp" data-thn="${y}" data-bln="${jml}" onkeyup="formatIDR(this)" value="0"></td></tr>`;
  }
  document.getElementById('bodyTahun').innerHTML = htmlThn;
  nextStep(2);
}

function kalkulasiFinal() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  
  // Hitung Selisih Bulan
  const diffTime = Math.abs(d2 - d1);
  const totalHari = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  const thnKerja = Math.floor(totalHari / 365);

  let selisihGaji = 0, selisihTHR = 0, selisihKomp = 0;

  // 1. Logika Selisih Gaji
  document.querySelectorAll('.in-gaji').forEach(el => {
    let audit = masterUMP[el.dataset.thn] || 0;
    let riil = parseIDR(el.value);
    if(riil < audit) selisihGaji += (audit - riil);
  });

  // 2. Logika Selisih THR & Komp (Prorata UMP)
  const thrs = document.querySelectorAll('.in-thr'), komps = document.querySelectorAll('.in-komp');
  thrs.forEach((el, i) => {
    let auditProrata = (masterUMP[el.dataset.thn] || 0) / 12 * parseInt(el.dataset.bln);
    let dTHR = parseIDR(el.value), dKomp = parseIDR(komps[i].value);
    if(dTHR < auditProrata) selisihTHR += (auditProrata - dTHR);
    if(dKomp < auditProrata) selisihKomp += (auditProrata - dKomp);
  });

  // 3. LOGIKA PESANGON & UPMK (Pasal 40 PP 35/2021)
  let umpAudit = masterUMP[d2.getFullYear()] || 0;
  
  // Koefisien Pesangon
  let koefPes = 1;
  if(thnKerja < 1) koefPes = 1;
  else if(thnKerja < 2) koefPes = 2;
  else if(thnKerja < 3) koefPes = 3;
  else if(thnKerja < 4) koefPes = 4;
  else if(thnKerja < 5) koefPes = 5;
  else if(thnKerja < 6) koefPes = 6;
  else if(thnKerja < 7) koefPes = 7;
  else if(thnKerja < 8) koefPes = 8;
  else koefPes = 9;

  // Koefisien UPMK
  let koefUPMK = 0;
  if(thnKerja >= 3 && thnKerja < 6) koefUPMK = 2;
  else if(thnKerja >= 6 && thnKerja < 9) koefUPMK = 3;
  else if(thnKerja >= 9 && thnKerja < 12) koefUPMK = 4;
  else if(thnKerja >= 12 && thnKerja < 15) koefUPMK = 5;
  else if(thnKerja >= 15 && thnKerja < 18) koefUPMK = 6;
  else if(thnKerja >= 18 && thnKerja < 21) koefUPMK = 7;
  else if(thnKerja >= 21 && thnKerja < 24) koefUPMK = 8;
  else if(thnKerja >= 24) koefUPMK = 10;

  let nominalPesangon = koefPes * umpAudit;
  let nominalUPMK = koefUPMK * umpAudit;
  let grandTotal = selisihGaji + selisihTHR + selisihKomp + nominalPesangon + nominalUPMK;

  nextStep(4);
  document.getElementById('rincianHasil').innerHTML = `
    <div class="list-group-item d-flex justify-content-between small"><span>Masa Kerja</span><b>${thnKerja} Tahun</b></div>
    <div class="list-group-item d-flex justify-content-between text-danger"><span>Selisih Gaji</span><b>Rp ${Math.round(selisihGaji).toLocaleString()}</b></div>
    <div class="list-group-item d-flex justify-content-between text-danger"><span>Selisih THR</span><b>Rp ${Math.round(selisihTHR).toLocaleString()}</b></div>
    <div class="list-group-item d-flex justify-content-between text-danger"><span>Selisih Kompensasi</span><b>Rp ${Math.round(selisihKomp).toLocaleString()}</b></div>
    <div class="list-group-item d-flex justify-content-between text-primary"><span>Pesangon (${koefPes}x UMP)</span><b>Rp ${nominalPesangon.toLocaleString()}</b></div>
    <div class="list-group-item d-flex justify-content-between text-primary"><span>UPMK (${koefUPMK}x UMP)</span><b>Rp ${nominalUPMK.toLocaleString()}</b></div>
  `;
  document.getElementById('grandTotal').innerText = `Rp ${Math.round(grandTotal).toLocaleString()}`;
}
</script>
</body>
</html>
