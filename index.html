<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBSI Pocket</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .hidden { display: none !important; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <div id="pageLogin" class="card shadow p-4 mx-auto" style="max-width: 400px;">
        <h5 class="text-center fw-bold">LOGIN SBSI POCKET</h5>
        <input type="text" id="inpNik" class="form-control mb-2" placeholder="NIK">
        <input type="password" id="inpPin" class="form-control mb-3" placeholder="PIN">
        <button id="btnLogin" class="btn btn-danger w-100" onclick="handleLogin()">MASUK</button>
    </div>

    <div id="pageAudit" class="card shadow p-4 hidden mx-auto" style="max-width: 800px;">
        <div class="no-print">
            <h6 class="fw-bold">FORM AUDIT HAK</h6>
            <label class="small">Tgl Mulai Kerja</label>
            <input type="date" id="tglMulai" class="form-control mb-2">
            <label class="small">Tgl Selesai Kerja</label>
            <input type="date" id="tglSelesai" class="form-control mb-3">
            <button id="btnHitung" class="btn btn-primary w-100" onclick="eksekusiAudit()">HITUNG & CETAK</button>
        </div>
        <div id="hasilPrint" class="mt-4"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwFmoWZTtRWozJyWcFpOH2z_XZia8U891PVvQNuGWzqCM5LRU1W8oEBidUq93Ys9KPD/exec"; // GANTI INI!
    let currentUser = null, masterUMP = [];

    function showPage(id) {
        document.getElementById('pageLogin').classList.add('hidden');
        document.getElementById('pageAudit').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    async function handleLogin() {
        const nik = document.getElementById('inpNik').value;
        const pin = document.getElementById('inpPin').value;
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "login", nik: nik, pin: pin }) });
            const data = await res.json();
            if(data.status === "success") {
                currentUser = data.user;
                masterUMP = data.allUMP;
                showPage('pageAudit');
            } else { alert(data.message); }
        } catch(e) { alert("Error koneksi!"); }
    }

    async function eksekusiAudit() {
        const d1 = new Date(document.getElementById('tglMulai').value);
        const d2 = new Date(document.getElementById('tglSelesai').value);
        if(isNaN(d1) || isNaN(d2)) return alert("Isi tanggal!");

        const formatIDR = (n) => "Rp " + Math.round(n).toLocaleString('id-ID');
        let thnMulai = d1.getFullYear(), thnSelesai = d2.getFullYear();
        let selisihGaji = 0, selisihTHR = 0, rincianHTML = "";

        for (let y = thnMulai; y <= thnSelesai; y++) {
            let dataUMP = masterUMP.find(u => u.tahun == y) || masterUMP[masterUMP.length-1];
            selisihGaji += (dataUMP.nilai * 12);
            selisihTHR += dataUMP.nilai;
            rincianHTML += `<tr><td>Upah ${y}</td><td>${formatIDR(dataUMP.nilai)}</td></tr>`;
        }

        let masaKerja = thnSelesai - thnMulai;
        let komp = masaKerja * masterUMP[masterUMP.length-1].nilai;
        let pesangon = (masaKerja >= 3) ? (2 * masterUMP[masterUMP.length-1].nilai) : 0;
        let total = selisihGaji + selisihTHR + komp + pesangon;

        document.getElementById('hasilPrint').innerHTML = `
            <table class="table table-bordered small">
                <tr class="table-dark"><td colspan="2">HASIL AUDIT: ${currentUser.nama}</td></tr>
                ${rincianHTML}
                <tr><td>Total Selisih Gaji</td><td>${formatIDR(selisihGaji)}</td></tr>
                <tr><td>Total Selisih THR</td><td>${formatIDR(selisihTHR)}</td></tr>
                <tr><td>Kompensasi</td><td>${formatIDR(komp)}</td></tr>
                <tr><td>Pesangon (UPMK)</td><td>${formatIDR(pesangon)}</td></tr>
                <tr class="table-danger fw-bold"><td>TOTAL TUNTUTAN</td><td>${formatIDR(total)}</td></tr>
            </table>`;

        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "audit", nama: currentUser.nama, tglMulai: d1.toISOString(), tglSelesai: d2.toISOString(),
                selisihGaji: selisihGaji, selisihTHR: selisihTHR, selisihKomp: komp, pesangonUPMK: pesangon, totalTuntutan: total
            })
        });
        setTimeout(() => window.print(), 500);
    }
</script>
</body>
</html>
