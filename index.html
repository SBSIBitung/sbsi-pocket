<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --sbsi-red: #b71c1c; }
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .btn-sbsi { background-color: var(--sbsi-red); color: white; border: none; }
    .btn-sbsi:hover { background-color: #8e1616; color: white; }
    .card-login { max-width: 400px; margin: 80px auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: none; }
    #loader { display: none; }
    .nav-sbsi { background: var(--sbsi-red); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .card-custom { border-radius: 12px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  </style>
</head>
<body>

<div id="app">
  <div id="loginSection">
    <div class="card card-login p-4">
      <div class="text-center mb-4">
        <h2 class="fw-bold text-danger">mySBSI</h2>
        <p class="text-muted small">Advokasi Hak Buruh & Anggota</p>
      </div>
      <div class="mb-2">
        <label class="small fw-bold">Username (NIK)</label>
        <input type="text" id="username" class="form-control" placeholder="7170...">
      </div>
      <div class="mb-3">
        <label class="small fw-bold">Password</label>
        <input type="password" id="password" class="form-control" placeholder="***">
      </div>
      <button onclick="prosesLogin()" id="btnLogin" class="btn btn-sbsi w-100 mb-2 fw-bold">LOGIN</button>
      <button onclick="masukGuest()" class="btn btn-outline-dark w-100 fw-bold small">MASUK SEBAGAI GUEST</button>
      <div id="loader" class="text-center mt-3"><div class="spinner-border text-danger spinner-border-sm"></div></div>
      <div id="msgError" class="text-danger text-center mt-2 small fw-bold"></div>
    </div>
  </div>

  <div id="mainSection" style="display:none;">
    <nav class="navbar nav-sbsi px-3 mb-4">
      <span class="navbar-brand fw-bold text-white">mySBSI Dashboard</span>
      <div class="ms-auto d-flex align-items-center">
        <span id="userDisplay" class="me-3 small text-white"></span>
        <button class="btn btn-sm btn-light fw-bold" onclick="location.reload()">Logout</button>
      </div>
    </nav>

    <div class="container">
      <div id="viewGuest" class="card card-custom p-5 text-center" style="display:none;">
        <h3 class="text-danger fw-bold">Profil SBSI</h3>
        <p class="lead">Serikat Buruh Sejahtera Indonesia</p>
        <hr class="w-25 mx-auto">
        <p class="mt-3">Gunakan akun Anda untuk mengakses <b>Kalkulator PHK</b> yang akurat sesuai aturan terbaru. Guest hanya memiliki akses informasi publik.</p>
      </div>

      <div id="viewUser" style="display:none;">
        <div class="row">
          <div class="col-md-5">
            <div class="card card-custom p-4 mb-4">
              <h5 class="fw-bold text-danger mb-3">Kalkulator PHK</h5>
              <div class="mb-2 small">
                <label class="fw-bold">Perusahaan:</label>
                <input type="text" id="namaPers" class="form-control-plaintext fw-bold text-primary" readonly>
              </div>
              <div class="row mb-2">
                <div class="col"><label class="small fw-bold">Tgl Mulai Kerja</label><input type="date" id="tglMulai" class="form-control"></div>
                <div class="col"><label class="small fw-bold">Tgl PHK</label><input type="date" id="tglSelesai" class="form-control"></div>
              </div>
              <div class="mb-3">
                <label class="small fw-bold">Upah Terakhir (Pokok + Tunj Tetap)</label>
                <input type="number" id="upahUser" class="form-control" placeholder="Contoh: 4000000">
              </div>
              <button onclick="hitungHak()" class="btn btn-danger w-100 fw-bold py-2">ANALISA HAK SAYA</button>
            </div>
          </div>
          <div class="col-md-7">
            <div id="hasilArea" class="card card-custom p-4 border-start border-danger border-5" style="display:none;">
              <h5 class="fw-bold text-danger border-bottom pb-2">Rincian Tuntutan Hak</h5>
              <div id="outputKalkulasi" class="mt-3"></div>
              <button id="btnSimpan" onclick="simpanData()" class="btn btn-success w-100 mt-3 fw-bold">SIMPAN KE DATABASE</button>
            </div>
            
            <div id="adminArea" class="card card-custom p-4 mt-3" style="display:none;">
              <h5 class="fw-bold mb-3 text-secondary">Log Riwayat Anggota (Admin)</h5>
              <div class="table-responsive">
                <table class="table table-hover table-sm small">
                  <thead class="table-light"><tr><th>Nama Anggota</th><th>Total Tuntutan</th></tr></thead>
                  <tbody id="bodyRiwayat"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentUser = {};
let masterUMP = {};
let memoryHasil = {};

function prosesLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  document.getElementById('loader').style.display = 'block';
  document.getElementById('msgError').innerText = '';

  google.script.run.withSuccessHandler(res => {
    document.getElementById('loader').style.display = 'none';
    if(res.success) showDashboard(res);
    else document.getElementById('msgError').innerText = res.message;
  }).loginUser(u, p);
}

function masukGuest() {
  showDashboard({role:'Guest', nama:'Tamu'});
}

function showDashboard(user) {
  currentUser = user;
  document.getElementById('loginSection').style.display='none';
  document.getElementById('mainSection').style.display='block';
  document.getElementById('userDisplay').innerText = `${user.nama} [${user.role}]`;

  if(user.role === 'Guest') {
    document.getElementById('viewGuest').style.display='block';
  } else {
    document.getElementById('viewUser').style.display='block';
    document.getElementById('namaPers').value = user.perusahaan || 'Multi Rempat Sulaw';
    google.script.run.withSuccessHandler(data => masterUMP = data).getUMP();
    if(user.role === 'Admin' || user.role === 'Super Admin') muatAdmin();
  }
}

function hitungHak() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  const upah = parseFloat(document.getElementById('upahUser').value);

  if(!d1 || !d2 || isNaN(upah)) return alert("Mohon isi tanggal dan upah!");

  const totalBulan = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24 * 30.44));
  const totalTahun = Math.floor(totalBulan / 12);
  
  // Perhitungan Pesangon PP 35/2021 (Contoh Sederhana)
  let kaliPesangon = totalTahun < 1 ? 1 : (totalTahun >= 8 ? 9 : totalTahun + 1);
  let pesangon = kaliPesangon * upah;
  
  const thn = d2.getFullYear().toString();
  const ump = masterUMP[thn] || 0;
  let selisihGaji = upah < ump ? (ump - upah) * 12 : 0;

  memoryHasil = {
    nama: currentUser.nama, tglMulai: d1.toISOString().split('T')[0], tglSelesai: d2.toISOString().split('T')[0],
    selisihGaji: selisihGaji, selisihTHR: 0, selisihKomp: 0, pesangon: pesangon,
    total: selisihGaji + pesangon,
    detail: { masaKerja: `${totalTahun} Thn ${totalBulan % 12} Bln`, agama: currentUser.agama }
  };

  document.getElementById('hasilArea').style.display='block';
  document.getElementById('outputKalkulasi').innerHTML = `
    <div class="alert alert-light border small">Masa Kerja: <b>${totalTahun} Tahun ${totalBulan % 12} Bulan</b></div>
    <div class="d-flex justify-content-between"><span>Selisih Gaji (vs UMP ${thn}):</span><b>Rp ${selisihGaji.toLocaleString()}</b></div>
    <div class="d-flex justify-content-between mb-2"><span>Uang Pesangon:</span><b>Rp ${pesangon.toLocaleString()}</b></div>
    <div class="d-flex justify-content-between h4 fw-bold text-danger border-top pt-2"><span>TOTAL HAK:</span><span>Rp ${memoryHasil.total.toLocaleString()}</span></div>
  `;
}

function simpanData() {
  document.getElementById('btnSimpan').disabled = true;
  google.script.run.withSuccessHandler(m => {
    alert(m);
    document.getElementById('btnSimpan').disabled = false;
    if(currentUser.role !== 'Karyawan') muatAdmin();
  }).saveToDatabase(memoryHasil);
}

function muatAdmin() {
  document.getElementById('adminArea').style.display='block';
  google.script.run.withSuccessHandler(data => {
    let html = '';
    data.forEach(r => html += `<tr><td>${r[1]}</td><td><b>Rp ${r[8].toLocaleString()}</b></td></tr>`);
    document.getElementById('bodyRiwayat').innerHTML = html;
  }).getRiwayat();
}
</script>
</body>
</html>
