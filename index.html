<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBSI Pocket Pro - DPC Bitung</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main-blue: #0d6efd; --soft-bg: #f0f2f5; }
        body { background-color: var(--soft-bg); font-family: 'Segoe UI', sans-serif; }
        .card-custom { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .nav-sbsi { background: white; border-bottom: 2px solid #dee2e6; }
        .nav-link { color: #6c757d; font-weight: 600; padding: 15px 20px !important; }
        .nav-link.active { color: var(--main-blue) !important; border-bottom: 3px solid var(--main-blue); }
        .profile-pic { width: 120px; height: 120px; object-fit: cover; border: 4px solid white; border-radius: 50%; shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .currency-input { text-align: right; font-weight: bold; color: var(--main-blue); }
        .xs { font-size: 0.75rem; font-weight: bold; color: #6c757d; }
        #pageLogin { max-width: 420px; margin: 80px auto; }
        .btn-blue { background: var(--main-blue); color: white; border-radius: 12px; font-weight: 600; border: none; padding: 12px; }
        /* Style khusus PDF agar rapi saat didownload */
        #pdf-content { padding: 20px; background: white; }
    </style>
</head>
<body>

<div id="sectionLogin" class="container">
    <div id="pageLogin" class="card card-custom p-5 bg-white text-center shadow">
        <img src="Logo_SBSI.png" width="90" class="mb-3 mx-auto">
        <h4 class="fw-bold text-primary">SBSI POCKET</h4>
        <p class="text-muted small mb-4">DPC Federasi SBSI Kota Bitung</p>
        <div class="text-start">
            <label class="xs">NIK</label>
            <input type="text" id="logNik" class="form-control mb-3" placeholder="7172...">
            <label class="xs">PIN</label>
            <input type="password" id="logPin" class="form-control mb-4" placeholder="***">
        </div>
        <button id="btnLogin" class="btn btn-blue w-100" onclick="doLogin()">MASUK</button>
    </div>
</div>

<nav id="mainNav" class="navbar navbar-expand nav-sbsi d-none sticky-top">
    <div class="container justify-content-center">
        <div class="navbar-nav">
            <a class="nav-link active" id="lDash" href="#" onclick="showTab('tabDash', 'lDash')">PROFIL</a>
            <a class="nav-link" id="lAudit" href="#" onclick="showTab('tabAudit', 'lAudit')">AUDIT HAK</a>
            <a class="nav-link" id="lQA" href="#" onclick="showTab('tabQA', 'lQA')">Q&A</a>
        </div>
    </div>
</nav>

<div id="sectionMain" class="container py-4 d-none">
    
    <div id="tabDash" class="tab-content">
        <div class="card card-custom bg-white p-4 text-center mx-auto shadow-sm" style="max-width: 450px;">
            <div class="position-relative d-inline-block mx-auto" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
                <img id="uFoto" src="" class="profile-pic bg-light">
                <div class="position-absolute bottom-0 end-0 bg-primary p-2 rounded-circle text-white shadow"><i class="bi bi-camera"></i></div>
                <input type="file" id="fileInput" class="d-none" accept="image/*" onchange="handleFileUpload(this)">
            </div>
            <h4 id="uNama" class="fw-bold mt-4 mb-0"></h4>
            <span id="uRole" class="badge bg-primary mx-auto mt-2 mb-4"></span>
            <div class="row text-start g-3 border-top pt-4">
                <div class="col-5 xs">NIK</div><div class="col-7 small fw-bold" id="uNik"></div>
                <div class="col-5 xs">ALAMAT</div><div class="col-7 small fw-bold" id="uAlamat"></div>
            </div>
            <button class="btn btn-link text-danger mt-5 text-decoration-none fw-bold" onclick="location.reload()">LOGOUT</button>
        </div>
    </div>

    <div id="tabAudit" class="tab-content d-none">
        <div class="card card-custom p-4 bg-white mx-auto shadow-sm" style="max-width: 650px;">
            
            <div id="stepAudit1">
                <h5 class="fw-bold text-primary mb-4">Periode Kerja</h5>
                <div class="row g-3 mb-4">
                    <div class="col-6"><label class="xs">TGL MULAI</label><input type="date" id="t1" class="form-control"></div>
                    <div class="col-6"><label class="xs">TGL SELESAI</label><input type="date" id="t2" class="form-control"></div>
                </div>
                <button class="btn btn-blue w-100 py-3" onclick="genGaji()">LANJUT</button>
            </div>

            <div id="stepAudit2" class="d-none">
                <div id="listGaji" class="border rounded mb-3 bg-white overflow-auto" style="max-height: 200px;"></div>
                <div id="listTahunan" class="mb-4"></div>
                <div class="p-3 bg-light rounded-4 border-start border-primary border-4 mb-4">
                    <label class="xs mb-2 d-block">PESANGON DITERIMA (Rp)</label>
                    <input type="text" id="pesDiterima" class="form-control currency-input mb-3" onkeyup="formatRp(this)" value="Rp 0">
                    <div class="form-check p-2 bg-white rounded border border-danger">
                        <input class="form-check-input ms-1" type="checkbox" id="chkMeninggal">
                        <label class="form-check-label small fw-bold text-danger ms-2" for="chkMeninggal">PHK KARENA MENINGGAL DUNIA</label>
                    </div>
                </div>
                <button id="btnProses" class="btn btn-blue w-100 py-3 shadow" onclick="prosesAudit()">HITUNG HAK SEKARANG</button>
            </div>

            <div id="resAudit" class="d-none mt-4">
                <div id="pdf-area" class="p-4 rounded-4 border border-primary bg-white">
                    <div class="text-center mb-4">
                        <img src="Logo_SBSI.png" width="60">
                        <h5 class="fw-bold mt-2">HASIL AUDIT HAK PEKERJA</h5>
                        <p class="xs">DPC FEDERASI SBSI KOTA BITUNG</p>
                    </div>
                    <div class="small mb-4 border-bottom pb-2">
                        <div><b>Nama:</b> <span id="pNama"></span></div>
                        <div><b>Periode:</b> <span id="pPeriode"></span></div>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small"><span>Selisih Gaji:</span> <b id="rGaji"></b></div>
                    <div class="d-flex justify-content-between mb-2 small"><span>Selisih THR:</span> <b id="rThr"></b></div>
                    <div class="d-flex justify-content-between mb-2 small"><span>Selisih Kompensasi:</span> <b id="rKomp"></b></div>
                    <div class="d-flex justify-content-between mb-2 text-primary small"><span>Pesangon (<span id="rDet"></span>):</span> <b id="rPes"></b></div>
                    <hr>
                    <div class="d-flex justify-content-between h4 fw-bold text-danger"><span>TOTAL:</span> <span id="rTotal"></span></div>
                </div>
                <div class="row g-2 mt-4">
                    <div class="col-6"><button class="btn btn-success w-100 py-2 fw-bold" onclick="downloadPDF()"><i class="bi bi-file-earmark-pdf"></i> SIMPAN PDF</button></div>
                    <div class="col-6"><button class="btn btn-outline-secondary w-100 py-2 fw-bold" onclick="location.reload()">ULANGI</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tabQA" class="tab-content d-none">
        <div class="card card-custom p-4 bg-white mx-auto shadow-sm" style="max-width: 700px;">
            <h5 class="fw-bold text-primary mb-4">Tanya Jawab</h5>
            <div class="accordion accordion-flush" id="qaAccordion"></div>
        </div>
    </div>

</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzgAMVfM8A4GTOACxeW5PhZLNRlhf61LEuwBA3XdzSgzhUNPtMkXXmTnLd0ASOY_avp/exec"; // Masukkan URL hasil Deploy Anda
    let USER = null;

    function formatRp(el) {
        let v = el.value.replace(/[^,\d]/g, ""); 
        el.value = "Rp " + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function clean(v) { return Number(v.replace(/[^0-9]/g, '')) || 0; }

    async function doLogin() {
        const btn = document.getElementById('btnLogin');
        const nik = document.getElementById('logNik').value;
        const pin = document.getElementById('logPin').value;
        btn.disabled = true; btn.innerText = "PROSES...";
        try {
            const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: "login", nik, pin }) });
            const d = await res.json();
            if(d.status === "success") {
                USER = d.user;
                document.getElementById('sectionLogin').classList.add('d-none');
                document.getElementById('mainNav').classList.remove('d-none');
                document.getElementById('sectionMain').classList.remove('d-none');
                renderUser(); loadQA();
            } else { alert(d.message); btn.disabled = false; btn.innerText = "MASUK"; }
        } catch(e) { alert("Error!"); btn.disabled = false; }
    }

    function renderUser() {
        document.getElementById('uNama').innerText = USER.nama;
        document.getElementById('uNik').innerText = USER.nik;
        document.getElementById('uAlamat').innerText = USER.alamat;
        document.getElementById('uRole').innerText = USER.role;
        document.getElementById('uFoto').src = USER.foto || "https://via.placeholder.com/150";
    }

    function showTab(tabId, linkId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.remove('d-none');
        document.getElementById(linkId).classList.add('active');
    }

    function genGaji() {
        const d1 = document.getElementById('t1').value;
        const d2 = document.getElementById('t2').value;
        if(!d1 || !d2) return alert("Pilih tanggal!");
        
        let hGaji = "", hThn = "", thns = [];
        let cur = new Date(new Date(d1).getFullYear(), new Date(d1).getMonth(), 1);
        while(cur <= new Date(d2)) {
            let lbl = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"][cur.getMonth()] + " " + cur.getFullYear();
            thns.push(cur.getFullYear());
            hGaji += `<div class="p-2 border-bottom d-flex justify-content-between align-items-center small"><span>${lbl}</span><input type="text" class="form-control form-control-sm val-gaji w-50 currency-input" onkeyup="formatRp(this)" value="Rp 1.750.000" data-bln="${lbl}"></div>`;
            cur.setMonth(cur.getMonth() + 1);
        }
        [...new Set(thns)].forEach(t => {
            hThn += `<div class="p-2 border rounded mb-2 bg-white small"><div class="fw-bold mb-1">${t}</div><div class="row g-1">
                <div class="col-6"><label class="xs">THR</label><input type="text" class="form-control form-control-sm val-thr currency-input" onkeyup="formatRp(this)" value="Rp 1.500.000" data-thn="${t}"></div>
                <div class="col-6"><label class="xs">KOMP</label><input type="text" class="form-control form-control-sm val-komp currency-input" onkeyup="formatRp(this)" value="Rp 0" data-thn="${t}"></div>
            </div></div>`;
        });
        document.getElementById('listGaji').innerHTML = hGaji;
        document.getElementById('listTahunan').innerHTML = hThn;
        document.getElementById('stepAudit1').classList.add('d-none');
        document.getElementById('stepAudit2').classList.remove('d-none');
    }

    async function prosesAudit() {
        const btn = document.getElementById('btnProses');
        btn.disabled = true; btn.innerText = "MENGHITUNG...";
        const data = {
            action: "audit", nama: USER.nama, tglMulai: document.getElementById('t1').value, tglSelesai: document.getElementById('t2').value,
            isMeninggal: document.getElementById('chkMeninggal').checked,
            masaKerja: Math.floor((new Date(document.getElementById('t2').value) - new Date(document.getElementById('t1').value)) / (365.25 * 24 * 60 * 60 * 1000)),
            pesangonDiterima: clean(document.getElementById('pesDiterima').value),
            rincianGaji: Array.from(document.querySelectorAll('.val-gaji')).map(i => ({ bulan: i.dataset.bln, gaji: clean(i.value) })),
            rincianTahunan: Array.from(document.querySelectorAll('.val-thr')).map((i, idx) => ({ tahun: i.dataset.thn, thr: clean(i.value), komp: clean(document.querySelectorAll('.val-komp')[idx].value) }))
        };
        const r = await (await fetch(API, { method: 'POST', body: JSON.stringify(data) })).json();
        if(r.status === "success") {
            document.getElementById('stepAudit2').classList.add('d-none');
            document.getElementById('resAudit').classList.remove('d-none');
            document.getElementById('pNama').innerText = USER.nama;
            document.getElementById('pPeriode').innerText = data.tglMulai + " s/d " + data.tglSelesai;
            document.getElementById('rGaji').innerText = "Rp " + r.gaji;
            document.getElementById('rThr').innerText = "Rp " + r.thr;
            document.getElementById('rKomp').innerText = "Rp " + r.komp;
            document.getElementById('rPes').innerText = "Rp " + r.pesangon;
            document.getElementById('rDet').innerText = r.detail;
            document.getElementById('rTotal').innerText = "Rp " + r.total;
        }
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-area');
        const opt = {
            margin: 10,
            filename: 'Audit_SBSI_' + USER.nama + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    async function handleFileUpload(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        document.getElementById('uFoto').style.opacity = "0.3";
        reader.onload = async (e) => {
            const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: "uploadFoto", nik: USER.nik, rowIndex: USER.rowIndex, base64: e.target.result }) });
            const d = await res.json();
            if(d.status === "success") { USER.foto = d.url; renderUser(); }
            document.getElementById('uFoto').style.opacity = "1";
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function loadQA() {
        const r = await (await fetch(API, { method: 'POST', body: JSON.stringify({ action: "getQA" }) })).json();
        let h = "";
        r.data.forEach((item, i) => {
            h += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed small fw-bold" data-bs-toggle="collapse" data-bs-target="#q${i}">${item[0]}</button></h2><div id="q${i}" class="accordion-collapse collapse"><div class="accordion-body small text-muted bg-light">${item[1]}</div></div></div>`;
        });
        document.getElementById('qaAccordion').innerHTML = h;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
