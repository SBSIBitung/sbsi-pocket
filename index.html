<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .login-container { max-width: 400px; margin: 100px auto; }
    .wizard-step { display: none; }
    .wizard-step.active { display: block; }
    .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #004d40; border: none; }
    .btn-primary:hover { background-color: #00695c; }
  </style>
</head>
<body>

<div id="app" class="container mt-4">
  <div id="loginSection" class="login-container">
    <div class="card p-4 text-center">
      <h3 class="mb-4">mySBSI Login</h3>
      <input type="text" id="username" class="form-control mb-2" placeholder="NIK (Username)">
      <input type="password" id="password" class="form-control mb-3" placeholder="PIN (123)">
      <button onclick="handleLogin()" class="btn btn-primary w-100 mb-2">Login</button>
      <button onclick="guestLogin()" class="btn btn-outline-secondary w-100">Masuk sebagai Guest</button>
      <div id="loginMsg" class="text-danger mt-2 small"></div>
    </div>
  </div>

  <div id="dashboardSection" style="display:none;">
    <nav class="navbar navbar-dark bg-dark mb-4 px-3 rounded">
      <span class="navbar-brand">mySBSI - <span id="userRole"></span></span>
      <button class="btn btn-sm btn-danger" onclick="location.reload()">Logout</button>
    </nav>

    <div class="row">
      <div class="col-md-4">
        <div class="card p-3 mb-3">
          <h5>Profil Pengguna</h5>
          <hr>
          <p>Nama: <strong id="dispNama"></strong></p>
          <p>Perusahaan: <span id="dispPers"></span></p>
          <button id="btnStartHitung" class="btn btn-success w-100">Mulai Hitung Hak</button>
        </div>
      </div>

      <div class="col-md-8">
        <div id="adminTableArea" class="card p-3" style="display:none;">
          <h5>Riwayat Perhitungan (Admin View)</h5>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Nama</th><th>Mulai</th><th>Selesai</th><th>Total Tuntutan</th>
                </tr>
              </thead>
              <tbody id="riwayatBody"></tbody>
            </table>
          </div>
        </div>

        <div id="wizardArea" class="card p-4" style="display:none;">
          <div id="step1" class="wizard-step active">
            <h4>Step 1: Masa Kerja</h4>
            <label>Tanggal Mulai Bekerja:</label>
            <input type="date" id="tglMulai" class="form-control mb-3">
            <label>Tanggal Selesai/PHK:</label>
            <input type="date" id="tglSelesai" class="form-control mb-3">
            <button onclick="nextStep(2)" class="btn btn-primary">Lanjut</button>
          </div>

          <div id="step2" class="wizard-step text-center">
            <h4>Step 2: Menghitung...</h4>
            <div class="spinner-border text-success" role="status"></div>
            <p>Sistem sedang memvalidasi UMP dan menghitung selisih THR sesuai PP 35/2021...</p>
          </div>

          <div id="step3" class="wizard-step">
            <h4>Hasil Perhitungan Akurat</h4>
            <div id="hasilKalkulasi" class="bg-light p-3 rounded mb-3"></div>
            <button onclick="simpanKeDB()" class="btn btn-success" id="btnSimpan">Simpan ke Database</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentUser = {};
  let dataUMP = {};

  function handleLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    google.script.run.withSuccessHandler(res => {
      if(res.success) setupDashboard(res);
      else document.getElementById('loginMsg').innerText = res.message;
    }).loginUser(u, p);
  }

  function guestLogin() {
    setupDashboard({success:true, role:"Guest", nama:"Guest", perusahaan:"-"});
  }

  function setupDashboard(user) {
    currentUser = user;
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
    document.getElementById('userRole').innerText = user.role;
    document.getElementById('dispNama').innerText = user.nama;
    document.getElementById('dispPers').innerText = user.perusahaan || "-";

    if(user.role === 'Admin' || user.role === 'Super Admin') {
      loadAdminData();
    }
  }

  function loadAdminData() {
    document.getElementById('adminTableArea').style.display = 'block';
    google.script.run.withSuccessHandler(data => {
      let html = '';
      data.forEach(r => {
        html += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>Rp ${r[8].toLocaleString()}</td></tr>`;
      });
      document.getElementById('riwayatBody').innerHTML = html;
    }).getAdminData();
  }

  document.getElementById('btnStartHitung').onclick = () => {
    document.getElementById('wizardArea').style.display = 'block';
    google.script.run.withSuccessHandler(u => dataUMP = u).getUMP();
  };

  function nextStep(n) {
    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
    document.getElementById('step'+n).classList.add('active');
    if(n === 2) kalkulasiProses();
  }

  function kalkulasiProses() {
    // Simulasi Logic Perhitungan (Akan dipindahkan ke Backend di update berikutnya)
    const t1 = new Date(document.getElementById('tglMulai').value);
    const t2 = new Date(document.getElementById('tglSelesai').value);
    
    // Logic sederhana sementara (Demo)
    setTimeout(() => {
      let total = 5000000; // Contoh
      document.getElementById('hasilKalkulasi').innerHTML = `
        <p>Selisih Gaji: Rp 0</p>
        <p>Selisih THR: Rp 2.500.000</p>
        <p><strong>Total Hak: Rp ${total.toLocaleString()}</strong></p>
      `;
      nextStep(3);
    }, 1500);
  }

  function simpanKeDB() {
    if(currentUser.role === 'Guest') return alert("Guest tidak bisa simpan data");
    const payload = {
      nama: currentUser.nama,
      tglMulai: document.getElementById('tglMulai').value,
      tglSelesai: document.getElementById('tglSelesai').value,
      total: 5000000,
      detail: { note: "Kalkulasi Otomatis PP 35" }
    };
    google.script.run.withSuccessHandler(msg => alert(msg)).saveCalculation(payload);
  }
</script>
</body>
</html>
