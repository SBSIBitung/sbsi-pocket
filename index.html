<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBSI Pocket Professional</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --main-blue: #0d6efd; --soft-bg: #f0f2f5; }
        body { background-color: var(--soft-bg); font-family: 'Inter', sans-serif; }
        .card-custom { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .nav-sbsi { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-link { color: #6c757d; font-weight: 600; padding: 15px 20px !important; }
        .nav-link.active { color: var(--main-blue) !important; border-bottom: 3px solid var(--main-blue); }
        .profile-pic { width: 130px; height: 130px; object-fit: cover; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 50%; }
        .btn-blue { background: var(--main-blue); color: white; border-radius: 12px; font-weight: 600; border: none; }
        .btn-blue:hover { background: #0b5ed7; color: white; }
        #pageLogin { max-width: 420px; margin: 100px auto; }
        .upload-overlay { cursor: pointer; transition: 0.3s; }
        .upload-overlay:hover { opacity: 0.7; }
    </style>
</head>
<body>

<div id="sectionLogin" class="container">
    <div id="pageLogin" class="card card-custom p-5 bg-white text-center">
        <img src="Logo_SBSI.png" width="90" class="mb-4">
        <h4 class="fw-bold mb-1">Selamat Datang</h4>
        <p class="text-muted small mb-4">Masuk ke Sistem Pocket DPC Bitung</p>
        <div class="text-start">
            <label class="small fw-bold text-muted">NIK</label>
            <input type="text" id="logNik" class="form-control form-control-lg mb-3" placeholder="7172...">
            <label class="small fw-bold text-muted">PIN</label>
            <input type="password" id="logPin" class="form-control form-control-lg mb-4" placeholder="***">
        </div>
        <button class="btn btn-blue w-100 py-3" onclick="doLogin()">MASUK APLIKASI</button>
    </div>
</div>

<nav id="mainNav" class="navbar navbar-expand nav-sbsi d-none sticky-top">
    <div class="container justify-content-center">
        <div class="navbar-nav">
            <a class="nav-link active" id="lDash" href="#" onclick="showTab('tabDash', 'lDash')"><i class="bi bi-person-circle"></i> PROFIL</a>
            <a class="nav-link" id="lAudit" href="#" onclick="showTab('tabAudit', 'lAudit')"><i class="bi bi-calculator"></i> AUDIT</a>
            <a class="nav-link" id="lQA" href="#" onclick="showTab('tabQA', 'lQA')"><i class="bi bi-patch-question"></i> TANYA JAWAB</a>
        </div>
    </div>
</nav>

<div id="sectionMain" class="container py-5 d-none">
    
    <div id="tabDash" class="tab-content">
        <div class="card card-custom bg-white p-4 text-center mx-auto" style="max-width: 500px;">
            <div class="position-relative d-inline-block mx-auto upload-overlay" onclick="document.getElementById('fileInput').click()">
                <img id="uFoto" src="" class="profile-pic bg-light">
                <div class="position-absolute bottom-0 end-0 bg-blue p-2 rounded-circle text-white shadow" style="background:var(--main-blue)">
                    <i class="bi bi-camera-fill"></i>
                </div>
                <input type="file" id="fileInput" class="d-none" accept="image/*" onchange="handleFileUpload(this)">
            </div>
            <h4 id="uNama" class="fw-bold mt-4 mb-0"></h4>
            <p id="uNik" class="text-muted small mb-4"></p>
            
            <div class="row text-start g-3 border-top pt-4">
                <div class="col-5 text-muted small">TEMPAT LAHIR</div><div class="col-7 fw-bold small" id="uTempat"></div>
                <div class="col-5 text-muted small">ALAMAT</div><div class="col-7 fw-bold small" id="uAlamat"></div>
                <div class="col-5 text-muted small">JABATAN</div><div class="col-7 fw-bold small"><span id="uRole" class="badge bg-primary"></span></div>
            </div>
            <button class="btn btn-link text-danger mt-5 text-decoration-none fw-bold" onclick="location.reload()">LOGOUT</button>
        </div>
    </div>

    <div id="tabAudit" class="tab-content d-none">
        <div class="card card-custom p-4 bg-white mx-auto" style="max-width: 650px;">
            <h5 class="fw-bold text-primary mb-4"><i class="bi bi-calculator"></i> Hitung Hak Pekerja</h5>
            <div class="alert alert-info small">Masukkan masa kerja Anda untuk memulai audit prorata otomatis.</div>
            <div class="row g-3 mb-4">
                <div class="col-6"><label class="small fw-bold">TGL MULAI</label><input type="date" id="tglMulai" class="form-control"></div>
                <div class="col-6"><label class="small fw-bold">TGL SELESAI</label><input type="date" id="tglSelesai" class="form-control"></div>
            </div>
            <button class="btn btn-blue w-100 py-3" onclick="alert('Lanjutkan ke input gaji...')">MULAI ANALISIS</button>
        </div>
    </div>

    <div id="tabQA" class="tab-content d-none">
        <div class="card card-custom p-4 bg-white mx-auto" style="max-width: 700px;">
            <h5 class="fw-bold text-primary mb-4"><i class="bi bi-chat-left-dots"></i> Tanya Jawab SBSI</h5>
            <div class="accordion accordion-flush" id="qaAccordion">
                </div>
        </div>
    </div>

</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwzZxQswylq0CRRrszkbhmjIGs_Nkv-rxIn0Djlez6QvSgjiiy76tItqVKp0Xcy7WjE/exec";
    let USER = null;

    async function doLogin() {
        const btn = document.querySelector('#pageLogin button');
        const nik = document.getElementById('logNik').value;
        const pin = document.getElementById('logPin').value;
        if(!nik || !pin) return alert("NIK/PIN Kosong!");

        btn.disabled = true; btn.innerText = "MENGECEK...";
        
        try {
            const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: "login", nik, pin }) });
            const d = await r.json();
            if(d.status === "success") {
                USER = d.user;
                document.getElementById('sectionLogin').classList.add('d-none');
                document.getElementById('mainNav').classList.remove('d-none');
                document.getElementById('sectionMain').classList.remove('d-none');
                renderUser();
                loadQA();
            } else { alert(d.message); btn.disabled = false; btn.innerText = "MASUK APLIKASI"; }
        } catch(e) { alert("Gagal koneksi!"); btn.disabled = false; }
    }

    function renderUser() {
        document.getElementById('uNama').innerText = USER.nama;
        document.getElementById('uNik').innerText = "NIK: " + USER.nik;
        document.getElementById('uTempat').innerText = USER.tempat;
        document.getElementById('uAlamat').innerText = USER.alamat;
        document.getElementById('uRole').innerText = USER.role;
        document.getElementById('uFoto').src = USER.foto || "https://via.placeholder.com/150?text=FOTO";
    }

    function showTab(tabId, linkId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.remove('d-none');
        document.getElementById(linkId).classList.add('active');
    }

    async function handleFileUpload(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();
        
        document.getElementById('uFoto').style.opacity = "0.3";
        
        reader.onload = async function(e) {
            const base64 = e.target.result;
            const res = await fetch(API, {
                method: 'POST',
                body: JSON.stringify({ action: "uploadFoto", nik: USER.nik, rowIndex: USER.rowIndex, base64: base64 })
            });
            const d = await res.json();
            if(d.status === "success") {
                USER.foto = d.url;
                renderUser();
                document.getElementById('uFoto').style.opacity = "1";
                alert("Foto profil berhasil diperbarui!");
            }
        };
        reader.readAsDataURL(file);
    }

    async function loadQA() {
        const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: "getQA" }) });
        const d = await r.json();
        let html = "";
        d.data.forEach((item, i) => {
            html += `<div class="accordion-item border-0 mb-2 shadow-sm rounded-3 overflow-hidden">
                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold small" data-bs-toggle="collapse" data-bs-target="#q${i}">${item[0]}</button></h2>
                <div id="q${i}" class="accordion-collapse collapse"><div class="accordion-body small text-muted bg-light">${item[1]}</div></div>
            </div>`;
        });
        document.getElementById('qaAccordion').innerHTML = html;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
