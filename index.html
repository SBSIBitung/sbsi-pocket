<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI Pocket Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --sbsi-red: #dc3545; --sbsi-dark: #1e1e2d; }
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background-color: #f4f6f9; font-family: sans-serif; margin: 0; }
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.6s; }
        .top-bar { background: white; padding: 12px 20px; border-bottom: 2px solid var(--sbsi-red); sticky: top; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .card-custom { border-radius: 20px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-main { background: var(--sbsi-red); color: white; border-radius: 12px; padding: 14px; font-weight: bold; border: none; width: 100%; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        #loading { background: rgba(255,255,255,0.9); z-index: 9999; display: none; position: fixed; width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="splash">
    <img src="Logo_SBSI.png" style="width: 160px;">
    <div class="mt-4 fw-bold text-danger" style="letter-spacing: 4px;">mySBSI</div>
</div>

<div id="loading" class="flex-column justify-content-center align-items-center">
    <div class="spinner-border text-danger"></div>
</div>

<div id="secLogin" class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 100vh;">
    <img src="Logo My SBSI.png" style="width: 180px;" class="mb-5">
    <div class="card card-custom p-4 w-100" style="max-width: 380px;">
        <input type="text" id="lNik" class="form-control mb-3 p-3" placeholder="Nomor NIK">
        <input type="password" id="lPin" class="form-control mb-4 p-3" placeholder="PIN">
        <button class="btn-main" onclick="doLogin()">MASUK</button>
    </div>
</div>

<div id="app" class="d-none">
    <div class="top-bar">
        <img src="Logo My SBSI.png" height="32">
        <button class="btn btn-sm text-danger fw-bold" onclick="location.reload()">LOGOUT</button>
    </div>

    <div class="container py-4">
        <div id="mainMenu" class="tab-content active">
            <div class="card card-custom bg-dark text-white p-4 mb-4">
                <small class="opacity-75">Halo,</small>
                <h4 id="uNama" class="fw-bold mb-0">--</h4>
                <div id="uNik" class="small mt-1 text-danger fw-bold">--</div>
            </div>
            <div class="row g-3">
                <div class="col-6" onclick="showTab('tAudit')">
                    <div class="card card-custom p-4 text-center h-100">
                        <i class="bi bi-calculator h1 text-danger"></i><br><b>Audit Hak</b>
                    </div>
                </div>
                <div class="col-6" onclick="showTab('tProfil')">
                    <div class="card card-custom p-4 text-center h-100">
                        <i class="bi bi-person-badge h1 text-danger"></i><br><b>Profil</b>
                    </div>
                </div>
            </div>
        </div>

        <div id="tAudit" class="tab-content">
            <div class="card card-custom p-4">
                <h5 class="fw-bold mb-4">Input Data PHK</h5>
                <div id="s1">
                    <label class="small fw-bold">Mulai Kerja</label><input type="date" id="d1" class="form-control mb-3">
                    <label class="small fw-bold">Tanggal PHK</label><input type="date" id="d2" class="form-control mb-4">
                    <button class="btn-main" onclick="genProrata()">LANJUTKAN</button>
                    <button class="btn btn-link w-100 text-muted mt-2" onclick="showTab('mainMenu')">Kembali</button>
                </div>
                <div id="s2" class="d-none">
                    <div id="listIn" class="mb-4" style="max-height: 400px; overflow-y: auto;"></div>
                    <button class="btn-main" onclick="prosesAudit()">HITUNG ESTIMASI</button>
                </div>
                <div id="sRes" class="d-none text-center">
                    <div class="p-4 bg-light rounded-4 mb-4">
                        <small class="fw-bold text-muted">TOTAL ESTIMASI HAK</small>
                        <h2 id="oTot" class="text-danger fw-bold mt-2">--</h2>
                    </div>
                    <button class="btn btn-outline-danger w-100 p-3" onclick="location.reload()">SELESAI</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyDQTK_7YYyjQm0Tds7W_tzuo5y9T9j3o_z1pgNqKyU1WKrsXxmSUh6jfT5dPcQaCcH/exec"; // Masukkan URL Deploy Anda di sini
    let USER = null;

    window.onload = () => { setTimeout(() => { document.getElementById('splash').style.opacity='0'; setTimeout(()=>document.getElementById('splash').style.display='none',600); }, 2500); };

    async function doLogin(){
        const nik = document.getElementById('lNik').value, pin = document.getElementById('lPin').value;
        if(!nik || !pin) return;
        loader(true);
        try {
            const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', nik, pin})});
            const d = await r.json();
            if(d.status==='success'){
                USER = d.user;
                document.getElementById('secLogin').classList.add('d-none');
                document.getElementById('app').classList.remove('d-none');
                document.getElementById('uNama').innerText = USER.nama;
                document.getElementById('uNik').innerText = USER.nik;
            } else alert(d.message);
        } catch(e) { alert("Koneksi gagal!"); }
        loader(false);
    }

    function showTab(id){
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function loader(s){ document.getElementById('loading').style.display = s ? 'flex' : 'none'; }

    function genProrata(){
        const d1 = new Date(document.getElementById('d1').value), d2 = new Date(document.getElementById('d2').value);
        let h = "";
        let curr = new Date(d1.getFullYear(), d1.getMonth(), 1);
        while(curr <= d2){
            let l = (curr.getMonth()+1)+"/"+curr.getFullYear();
            h += `<div class="mb-3"><label class="small fw-bold">${l}</label><input type="number" class="form-control in-g" data-b="${l}" value="3500000"></div>`;
            curr.setMonth(curr.getMonth()+1);
        }
        document.getElementById('listIn').innerHTML = h;
        document.getElementById('s1').classList.add('d-none');
        document.getElementById('s2').classList.remove('d-none');
    }

    async function prosesAudit(){
        loader(true);
        const rincian = Array.from(document.querySelectorAll('.in-g')).map(i=>({ bulan: i.dataset.b, gaji: Number(i.value) }));
        const payload = { action:'audit', tglMulai:document.getElementById('d1').value, tglSelesai:document.getElementById('d2').value, rincianGaji:rincian, pesangonDiterima:0, isMeninggal:false };
        try {
            const r = await (await fetch(API, {method:'POST', body:JSON.stringify(payload)})).json();
            document.getElementById('oTot').innerText = "Rp "+r.total.toLocaleString('id-ID');
            document.getElementById('s2').classList.add('d-none');
            document.getElementById('sRes').classList.remove('d-none');
        } catch(e){ alert("Perhitungan gagal!"); }
        loader(false);
    }
</script>
</body>
</html>
