<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary: #0d47a1; }
    body { background: #f4f7f6; font-size: 14px; }
    .card-pro { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .view-section { display: none; }
    .view-section.active { display: block; }
    .btn-blue { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; }
  </style>
</head>
<body>

<div id="viewLogin" class="view-section active">
  <div class="container py-5 text-center">
    <img src="https://raw.githubusercontent.com/sbsibitung/sbsi-pocket/main/Logo_SBSI.png" width="70" class="mb-3">
    <div class="card-pro mx-auto" style="max-width: 350px;">
      <input type="text" id="nik" class="form-control mb-2" placeholder="NIK">
      <input type="password" id="pin" class="form-control mb-3" placeholder="PIN">
      <button class="btn-blue" onclick="doLogin()">MASUK</button>
    </div>
  </div>
</div>

<div id="viewAudit" class="view-section">
  <nav class="navbar navbar-dark bg-primary mb-3"><div class="container"><span class="navbar-brand small">Audit Selisih Hak</span></div></nav>
  <div class="container">
    
    <div class="card-pro">
      <label class="fw-bold small">Tgl Masuk</label><input type="date" id="d1" class="form-control mb-2">
      <label class="fw-bold small">Tgl PHK</label><input type="date" id="d2" class="form-control mb-2" onchange="getUmp()">
      <label class="fw-bold small">Upah Seharusnya (Berdasarkan UMP)</label>
      <input type="text" id="uAturan" class="form-control mb-2 bg-light" readonly>
    </div>

    <div class="card-pro">
      <h6 class="text-danger fw-bold">Data Aktual (Yang Diterima)</h6>
      <label class="small">Upah yg dibayar Perusahaan</label><input type="number" id="uAktual" class="form-control mb-2">
      <label class="small">Pesangon + UPMK yg sudah cair</label><input type="number" id="hAktual" class="form-control mb-3">
      <button class="btn-blue" onclick="prosesAudit()">HITUNG SELISIH</button>
    </div>

    <div id="hasilBox" class="card-pro d-none border-primary border">
      <h6 class="fw-bold border-bottom pb-2">Hasil Analisis Audit</h6>
      <div id="rincian" class="small"></div>
    </div>

  </div>
</div>

<script>
  const API = "https://script.google.com/macros/s/AKfycbwbgTTY3Vv2LD9cYEQ_vc5H0bjYnAN11HuHtCjMZ75ZHNEvEipZSHefu7KTe1eUdUL0/exec"; 

  async function doLogin() {
    const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', nik:document.getElementById('nik').value, pin:document.getElementById('pin').value})});
    const d = await r.json();
    if(d.status==='success') showView('viewAudit'); else alert(d.msg);
  }

  async function getUmp() {
    const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'getUmpRef', year:new Date(document.getElementById('d2').value).getFullYear()})});
    const d = await r.json();
    if(d.status==='success') {
      document.getElementById('uAturan').value = d.ump;
      document.getElementById('uAturan').dataset.val = d.ump;
    }
  }

  function prosesAudit() {
    const d1 = new Date(document.getElementById('d1').value);
    const d2 = new Date(document.getElementById('d2').value);
    const uAturan = parseFloat(document.getElementById('uAturan').dataset.val);
    const uAktual = parseFloat(document.getElementById('uAktual').value) || 0;
    const hAktual = parseFloat(document.getElementById('hAktual').value) || 0;

    const mk = (d2 - d1) / (1000 * 60 * 60 * 24 * 365.25);
    
    // Logika Perkalian (p + pmk)
    let p = (mk<1)?1:(mk<2)?2:(mk<3)?3:(mk<4)?4:(mk<5)?5:(mk<6)?6:(mk<7)?7:(mk<8)?8:9;
    let pmk = (mk<3)?0:(mk<6)?2:(mk<9)?3:(mk<12)?4:(mk<15)?5:(mk<18)?6:(mk<21)?7:(mk<24)?8:10;

    const totalAturan = uAturan * (p + pmk);
    const selisihUpah = uAturan - uAktual;
    const selisihHak = totalAturan - hAktual;

    document.getElementById('hasilBox').classList.remove('d-none');
    document.getElementById('rincian').innerHTML = `
      <p>Masa Kerja: <b>${mk.toFixed(1)} Tahun</b></p>
      <p>Hak Seharusnya (${p}+${pmk} bln): <b>Rp ${totalAturan.toLocaleString()}</b></p>
      <p>Selisih Upah Bulanan: <b class="text-danger">Rp ${selisihUpah.toLocaleString()}</b></p>
      <p>Kekurangan Pesangon/UPMK: <b class="text-danger">Rp ${selisihHak.toLocaleString()}</b></p>
    `;
  }

  function showView(id) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
</script>
</body>
</html>
