<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mySBSI - Wizard Bulanan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --sbsi: #b71c1c; }
    body { background: #f4f4f4; font-size: 0.85rem; }
    .bg-sbsi { background: var(--sbsi); color: white; }
    .card-wizard { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .step { display: none; }
    .step.active { display: block; }
    .sticky-header { position: sticky; top: 0; background: white; z-index: 100; border-bottom: 2px solid var(--sbsi); }
    .table-input input { border: 1px solid #ddd; border-radius: 4px; padding: 2px 5px; width: 100%; text-align: right; }
    .table-input input:focus { border-color: var(--sbsi); outline: none; background: #fff8f8; }
  </style>
</head>
<body>

<div id="app">
  <div id="loginSection" class="container mt-5" style="max-width: 350px;">
    <div class="card card-wizard p-4 text-center">
      <h3 class="text-danger fw-bold mb-4">mySBSI</h3>
      <input type="text" id="username" class="form-control mb-2" placeholder="NIK">
      <input type="password" id="password" class="form-control mb-3" placeholder="Password">
      <button onclick="doLogin()" id="btnLogin" class="btn bg-sbsi w-100 fw-bold">MASUK</button>
      <div id="loader" class="mt-3" style="display:none;"><div class="spinner-border text-danger spinner-border-sm"></div></div>
    </div>
  </div>

  <div id="mainSection" style="display:none;">
    <nav class="navbar bg-sbsi px-3 mb-3 shadow-sm"><span class="fw-bold">Wizard Perhitungan Hak Bulanan</span></nav>
    <div class="container-fluid" style="max-width: 900px;">
      
      <div class="card card-wizard p-3">
        <div id="step1" class="step active">
          <h6 class="fw-bold text-danger mb-3">Langkah 1: Tentukan Masa Kerja</h6>
          <div class="row g-2">
            <div class="col-6"><label class="small fw-bold">Tanggal Mulai</label><input type="date" id="tglMulai" class="form-control"></div>
            <div class="col-6"><label class="small fw-bold">Tanggal PHK</label><input type="date" id="tglSelesai" class="form-control"></div>
          </div>
          <button onclick="generateMonthlyTable()" class="btn btn-danger w-100 mt-3 fw-bold">Buat Tabel Input Bulanan</button>
        </div>

        <div id="step2" class="step">
          <h6 class="fw-bold text-danger mb-2">Langkah 2: Masukkan Upah, THR & Komp Per Bulan</h6>
          <p class="text-muted x-small mb-3">*Gunakan simbol pemisah ribuan otomatis.</p>
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-input table-hover border">
              <thead class="sticky-header small text-center">
                <tr>
                  <th width="150">Bulan & Tahun</th>
                  <th>Upah (Rp)</th>
                  <th>THR (Rp)</th>
                  <th>Kompensasi (Rp)</th>
                </tr>
              </thead>
              <tbody id="tabelBody" class="small"></tbody>
            </table>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button onclick="nextStep(1)" class="btn btn-secondary w-25">Kembali</button>
            <button onclick="hitungFinal()" class="btn btn-danger w-75 fw-bold">HITUNG HASIL AKHIR</button>
          </div>
        </div>

        <div id="step3" class="step">
          <div class="text-center mb-3">
            <h5 class="fw-bold text-danger">REKAPITULASI HAK PESANGON</h5>
            <small class="text-muted">Berdasarkan PP 35 Tahun 2021</small>
          </div>
          <div id="hasilFinal" class="border rounded p-3 bg-white shadow-sm"></div>
          <button onclick="location.reload()" class="btn btn-dark w-100 mt-3 fw-bold">SELESAI & LOGOUT</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const WEB_APP_URL = "MASUKKAN_URL_WEB_APP_DI_SINI"; 
let masterUMP = {};

function callback(res) { window.lastRes = res; }

function formatIDR(el) {
  let val = el.value.replace(/\D/g, "");
  el.value = new Intl.NumberFormat('id-ID').format(val);
}

function parseIDR(val) {
  return parseFloat(val.replace(/\./g, "")) || 0;
}

function doLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  document.getElementById('loader').style.display = 'block';
  const script = document.createElement('script');
  script.src = `${WEB_APP_URL}?action=login&u=${u}&p=${p}&callback=callback`;
  document.body.appendChild(script);

  setTimeout(() => {
    document.getElementById('loader').style.display = 'none';
    if(window.lastRes && window.lastRes.success) {
      document.getElementById('loginSection').style.display='none';
      document.getElementById('mainSection').style.display='block';
      fetchUMP();
    } else { alert("Login Gagal!"); }
  }, 2000);
}

function fetchUMP() {
  const script = document.createElement('script');
  script.src = `${WEB_APP_URL}?action=getUMP&callback=callback`;
  document.body.appendChild(script);
  setTimeout(() => { masterUMP = window.lastRes; }, 1000);
}

function generateMonthlyTable() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  if(isNaN(d1) || isNaN(d2)) return alert("Isi tanggal!");

  let html = '';
  let curr = new Date(d1.getFullYear(), d1.getMonth(), 1);
  const end = new Date(d2.getFullYear(), d2.getMonth(), 1);

  const listBulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

  while(curr <= end) {
    let blnThn = `${listBulan[curr.getMonth()]} ${curr.getFullYear()}`;
    html += `<tr>
      <td class="fw-bold bg-light">${blnThn}</td>
      <td><input type="text" class="in-gaji" data-thn="${curr.getFullYear()}" onkeyup="formatIDR(this)" placeholder="0"></td>
      <td><input type="text" class="in-thr" onkeyup="formatIDR(this)" placeholder="0"></td>
      <td><input type="text" class="in-komp" onkeyup="formatIDR(this)" placeholder="0"></td>
    </tr>`;
    curr.setMonth(curr.getMonth() + 1);
  }
  document.getElementById('tabelBody').innerHTML = html;
  nextStep(2);
}

function nextStep(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step'+n).classList.add('active');
}

function hitungFinal() {
  const d1 = new Date(document.getElementById('tglMulai').value);
  const d2 = new Date(document.getElementById('tglSelesai').value);
  const diffBulan = Math.floor((d2 - d1) / (1000*60*60*24*30.44));
  const thnKerja = Math.floor(diffBulan / 12);

  let gajis = document.querySelectorAll('.in-gaji');
  let thrs = document.querySelectorAll('.in-thr');
  let komps = document.querySelectorAll('.in-komp');
  
  let totalSelisihUMP = 0;
  let totalTHR = 0;
  let totalKomp = 0;
  let upahTerakhir = parseIDR(gajis[gajis.length-1].value);

  gajis.forEach((el, i) => {
    let thn = el.getAttribute('data-thn');
    let gaji = parseIDR(el.value);
    let ump = masterUMP[thn] || 0;
    if(gaji > 0 && gaji < ump) totalSelisihUMP += (ump - gaji);
    totalTHR += parseIDR(thrs[i].value);
    totalKomp += parseIDR(komps[i].value);
  });

  // PP 35/2021 Pesangon (Pasal 40 ayat 2)
  let kPes = thnKerja < 1 ? 1 : (thnKerja >= 8 ? 9 : thnKerja + 1);
  let pesangon = kPes * upahTerakhir;

  // UPMK (Pasal 40 ayat 3)
  let kUPMK = 0;
  if(thnKerja >= 3 && thnKerja < 6) kUPMK = 2;
  else if(thnKerja >= 6 && thnKerja < 9) kUPMK = 3;
  else if(thnKerja >= 9 && thnKerja < 12) kUPMK = 4;
  else if(thnKerja >= 12 && thnKerja < 15) kUPMK = 5;
  else if(thnKerja >= 15 && thnKerja < 18) kUPMK = 6;
  else if(thnKerja >= 18 && thnKerja < 21) kUPMK = 7;
  else if(thnKerja >= 21 && thnKerja < 24) kUPMK = 8;
  else if(thnKerja >= 24) kUPMK = 10;
  let upmk = kUPMK * upahTerakhir;

  const grandTotal = totalSelisihUMP + pesangon + upmk + totalTHR + totalKomp;

  nextStep(3);
  document.getElementById('hasilFinal').innerHTML = `
    <div class="row g-2 small">
      <div class="col-7">Masa Kerja:</div><div class="col-5 text-end fw-bold">${thnKerja} Tahun</div>
      <div class="col-7">Upah Terakhir:</div><div class="col-5 text-end fw-bold text-primary">Rp ${upahTerakhir.toLocaleString()}</div>
      <hr class="my-1">
      <div class="col-7">Kekurangan Gaji (vs UMP):</div><div class="col-5 text-end">Rp ${totalSelisihUMP.toLocaleString()}</div>
      <div class="col-7">Uang Pesangon (${kPes}x):</div><div class="col-5 text-end">Rp ${pesangon.toLocaleString()}</div>
      <div class="col-7">Uang Penghargaan (UPMK ${kUPMK}x):</div><div class="col-5 text-end">Rp ${upmk.toLocaleString()}</div>
      <div class="col-7">Sisa THR:</div><div class="col-5 text-end">Rp ${totalTHR.toLocaleString()}</div>
      <div class="col-7">Uang Penggantian Hak:</div><div class="col-5 text-end">Rp ${totalKomp.toLocaleString()}</div>
      <div class="col-12 mt-2 p-2 bg-danger text-white rounded text-center">
        <div class="small">TOTAL HAK YANG HARUS DIBAYAR</div>
        <div class="h4 fw-bold mb-0">Rp ${grandTotal.toLocaleString()}</div>
      </div>
    </div>
  `;
}
</script>
</body>
</html>
