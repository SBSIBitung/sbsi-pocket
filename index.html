<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --blue: #0d47a1; }
    body { background: #f4f7f6; font-size: 13px; font-family: sans-serif; }
    .card-pro { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .step-view { display: none; }
    .active { display: block; }
    .btn-blue { background: var(--blue); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; }
    .header-box { background: var(--blue); color: white; padding: 15px; border-radius: 0 0 15px 15px; text-align: center; margin-bottom: 20px; }
  </style>
</head>
<body>

<div id="viewLogin" class="step-view active container py-5 text-center">
  <img src="https://raw.githubusercontent.com/sbsibitung/sbsi-pocket/main/Logo_SBSI.png" width="80" class="mb-4">
  <div class="card-pro mx-auto" style="max-width: 350px;">
    <h5 class="fw-bold mb-3">Login Auditor</h5>
    <input type="text" id="lNik" class="form-control mb-2" placeholder="NIK">
    <input type="password" id="lPin" class="form-control mb-3" placeholder="PIN">
    <button class="btn-blue" onclick="handleLogin()">MASUK</button>
  </div>
</div>

<div id="mainApp" class="step-view">
  <div class="header-box"><h5>KALKULATOR AUDIT HAK</h5><small id="userLabel"></small></div>
  <div class="container pb-5">
    
    <div id="step1" class="step-view active">
      <div class="card-pro">
        <h6 class="fw-bold text-primary mb-3">Tahap 1: Periode Kerja & Masa Kerja</h6>
        <label class="small fw-bold">Tanggal Masuk (TMT)</label><input type="date" id="tmt" class="form-control mb-2">
        <label class="small fw-bold">Tanggal PHK</label><input type="date" id="phk" class="form-control mb-3">
        <button id="btnStep1" class="btn-blue" onclick="toStep2()">LANJUT AUDIT UPAH BULANAN</button>
      </div>
    </div>

    <div id="step2" class="step-view">
      <div class="card-pro">
        <h6 class="fw-bold text-primary mb-2">Tahap 2: Audit Selisih Upah</h6>
        <div class="table-responsive"><table class="table table-sm table-bordered">
          <thead class="table-dark"><tr><th>Tahun</th><th>UMP</th><th>Upah Aktual</th></tr></thead>
          <tbody id="upahTable"></tbody>
        </table></div>
        <button class="btn-blue mt-3" onclick="toStep3()">LANJUT KE THR</button>
      </div>
    </div>

    <div id="step3" class="step-view">
      <div class="card-pro">
        <h6 class="fw-bold text-primary">Tahap 3: Dana Sudah Cair</h6>
        <div id="thrList"></div>
        <div id="boxMeninggal" class="d-none mt-3 p-2 border border-danger rounded text-center">
          <label class="text-danger fw-bold"><input type="checkbox" id="isMeninggal"> PEKERJA MENINGGAL (2x Pesangon)</label>
        </div>
        <button class="btn-blue mt-4" onclick="hitungFinal()">HITUNG SELISIH AKHIR</button>
      </div>
    </div>

    <div id="step4" class="step-view">
      <div class="card-pro border-primary text-center">
        <h5 class="fw-bold">HASIL AUDIT SELISIH</h5>
        <hr><div id="hasilDetail"></div>
        <button class="btn btn-warning w-100 mt-3" onclick="location.reload()">ULANGI</button>
      </div>
    </div>

  </div>
</div>

<script>
  // GANTI URL INI DENGAN URL WEB APP ANDA
  const API = "https://script.google.com/macros/s/AKfycbwy9ojeqHYxpOGZcf7P5T_GrBQUWTxtvBAwhDw-54m9lYvs1C48GFfrWHbVMcjqAyru/exec";
  let UMP = {};

  async function handleLogin() {
    const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', nik:document.getElementById('lNik').value, pin:document.getElementById('lPin').value})});
    const d = await r.json();
    if(d.status==='success') {
      document.getElementById('viewLogin').classList.remove('active');
      document.getElementById('mainApp').classList.add('active');
      document.getElementById('userLabel').innerText = "Auditor: " + d.user.nama;
      if(d.user.role === "Admin") document.getElementById('boxMeninggal').classList.remove('d-none');
      
      const r2 = await fetch(API, {method:'POST', body:JSON.stringify({action:'getUmpRef'})});
      const d2 = await r2.json(); UMP = d2.data;
    } else alert(d.message);
  }

  function toStep2() {
    const tmtVal = document.getElementById('tmt').value;
    const phkVal = document.getElementById('phk').value;
    if(!tmtVal || !phkVal) return alert("Isi tanggal dulu!");

    const y1 = new Date(tmtVal).getFullYear();
    const y2 = new Date(phkVal).getFullYear();
    let h = '';
    for(let y = y1; y <= y2; y++) {
      let vUmp = UMP[y] || 0;
      h += `<tr><td>${y}</td><td>Rp ${Number(vUmp).toLocaleString()}</td><td><input type="number" class="u-in form-control-sm" data-y="${y}" value="${vUmp}"></td></tr>`;
    }
    document.getElementById('upahTable').innerHTML = h;
    toStep(2);
  }

  function toStep3() {
    const y1 = new Date(document.getElementById('tmt').value).getFullYear();
    const y2 = new Date(document.getElementById('phk').value).getFullYear();
    let h = '';
    for(let y = y1; y <= y2; y++) h += `<div class="mb-2 small">THR Diterima Thn ${y}<input type="number" class="t-in form-control form-control-sm" value="0"></div>`;
    document.getElementById('thrList').innerHTML = h;
    toStep(3);
  }

  function hitungFinal() {
    const tmt = new Date(document.getElementById('tmt').value);
    const phk = new Date(document.getElementById('phk').value);
    const mk = (phk - tmt) / (1000 * 60 * 60 * 24 * 365.25);
    
    let pF = (mk<1)?1:(mk<2)?2:(mk<3)?3:(mk<4)?4:(mk<5)?5:(mk<6)?6:(mk<7)?7:(mk<8)?8:9;
    let pmkF = (mk<3)?0:(mk<6)?2:(mk<9)?3:(mk<12)?4:(mk<15)?5:(mk<18)?6:(mk<21)?7:(mk<24)?8:10;
    
    const mult = document.getElementById('isMeninggal').checked ? 2 : 1;
    const lastUmp = parseFloat(UMP[phk.getFullYear()]) || 0;
    const totalHakAturan = ((lastUmp * pF) * mult) + (lastUmp * pmkF);

    let sUpah = 0;
    document.querySelectorAll('.u-in').forEach(el => sUpah += (parseFloat(UMP[el.dataset.y] || 0) - parseFloat(el.value)) * 12);
    let sAktual = 0;
    document.querySelectorAll('.t-in').forEach(el => sAktual += parseFloat(el.value) || 0);

    const totalKurang = sUpah + totalHakAturan - sAktual;
    document.getElementById('hasilDetail').innerHTML = `
      <div class="alert alert-info small text-start">
        Pesangon: Rp ${lastUmp.toLocaleString()} x ${pF} bln ${mult>1?'x 2':''}<br>
        UPMK: Rp ${lastUmp.toLocaleString()} x ${pmkF} bln
      </div>
      <table class="table table-sm">
        <tr><td>Total Seharusnya</td><td class="text-end">Rp ${totalHakAturan.toLocaleString()}</td></tr>
        <tr><td>Selisih Gaji</td><td class="text-end">Rp ${sUpah.toLocaleString()}</td></tr>
        <tr><td>Sudah Dibayar</td><td class="text-end text-danger">- Rp ${sAktual.toLocaleString()}</td></tr>
        <tr class="table-primary fw-bold"><td>TOTAL KURANG</td><td class="text-end">Rp ${totalKurang.toLocaleString()}</td></tr>
      </table>`;
    toStep(4);
  }

  function toStep(n) {
    document.querySelectorAll('.step-view').forEach(v => v.classList.remove('active'));
    document.getElementById('step'+n).classList.add('active');
  }
</script>
</body>
</html>
